<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ship Assignment Tool</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Mohave:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Configure Tailwind to use custom fonts and colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                        'mohave': ['Mohave', 'sans-serif'],
                    },
                    colors: {
                        // Custom colors from user request
                        'mrs-bg': '#1f2937',
                        'mrs-box': '#1d2735',
                        'mrs-button': '#2b4e71',
                        'mrs-button-hover': '#254666', // A slightly darker hover
                        primary: tailwind.colors.blue,
                    }
                }
            }
        }
    </script>
    
    <!-- Minimal custom styles for drag-and-drop -->
    <style>
        .dragging {
            opacity: 0.5;
            background: #374151; /* bg-gray-700 */
        }
        
        /* Custom scrollbar for dropdowns */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #374151; /* bg-gray-700 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
    </style>
</head>
<body class="min-h-screen bg-mrs-bg p-0 font-sans text-gray-200">
    
    <!-- Header Bar -->
    <div class="w-full bg-mrs-box border-b border-gray-700 p-4 shadow-lg">
        <div class="mx-auto max-w-7xl">
            <h1 class="flex items-center gap-4 text-left font-mohave text-2xl font-semibold uppercase tracking-wide text-white">
                <img src="https://staff.medrunner.space/images/medrunner-logo-stable-white.svg" alt="Medrunner Logo" class="h-12 w-auto">
                <span>Medrunner Operations Tool</span>
            </h1>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="w-full bg-mrs-box border-b border-gray-700">
        <div class="mx-auto max-w-7xl px-4">
            <div class="flex gap-2">
                <button onclick="switchTab('shipAssignment')" id="tab-shipAssignment" class="tab-button active border-b-2 border-mrs-button px-6 py-3 font-mohave text-sm font-semibold uppercase tracking-wide text-white transition hover:bg-gray-700">
                    Ship Assignment
                </button>
                <button onclick="switchTab('aar')" id="tab-aar" class="tab-button border-b-2 border-transparent px-6 py-3 font-mohave text-sm font-semibold uppercase tracking-wide text-gray-400 transition hover:bg-gray-700 hover:text-white">
                    After Action Report
                </button>
                <button onclick="switchTab('tipSplitter')" id="tab-tipSplitter" class="tab-button border-b-2 border-transparent px-6 py-3 font-mohave text-sm font-semibold uppercase tracking-wide text-gray-400 transition hover:bg-gray-700 hover:text-white">
                    Tip Splitter
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="mx-auto max-w-7xl p-4 md:p-8">

        <!-- SHIP ASSIGNMENT TAB -->
        <div id="content-shipAssignment" class="tab-content">

        <!-- Import from Discord Card -->
        <div class="mb-6 rounded-lg border border-gray-700 bg-mrs-box p-5 shadow-lg md:p-6">
            <h2 class="mb-4 font-mohave text-2xl font-semibold uppercase tracking-wide text-white">Import from Discord</h2>
            <p class="mb-4 rounded-lg border border-blue-900 bg-blue-950/50 p-3 text-sm text-gray-300">
                ðŸ’¡ <strong class="text-white">Paste a Discord ship assignment message</strong> below to automatically populate the ship assignments. This is useful for team lead hand-overs.
            </p>
            <textarea id="import-discord-message" rows="8" placeholder="Paste your Discord ship assignment message here..." class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 font-mono transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"></textarea>
            <div class="mt-3 flex gap-3">
                <button onclick="importFromDiscord()" class="flex-1 rounded-lg border border-mrs-button bg-mrs-button px-5 py-2.5 text-sm font-medium text-white shadow-md transition hover:border-mrs-button-hover hover:bg-mrs-button-hover">Import & Populate</button>
                <button onclick="document.getElementById('import-discord-message').value = ''" class="rounded-lg border border-gray-600 bg-gray-700 px-5 py-2.5 text-sm font-medium text-white transition hover:bg-gray-600">Clear</button>
            </div>
            <div id="import-status" class="mt-3 hidden rounded-lg px-4 py-3 text-center font-medium"></div>
        </div>

        <!-- Ship Groups Card -->
        <div class="mb-6 rounded-lg border border-gray-700 bg-mrs-box p-5 shadow-lg md:p-6">
            <div class="mb-4 flex flex-col items-start justify-between gap-4 md:flex-row md:items-center">
                <h2 class="font-mohave text-2xl font-semibold uppercase tracking-wide text-white">Ship Groups</h2>
                <div class="flex w-full items-center gap-3 md:w-auto">
                    <span id="apiStatus" class="flex-1 rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-xs font-medium text-gray-300 md:flex-auto">Loading ships...</span>
                    <button class="rounded-lg border border-mrs-button bg-mrs-button px-4 py-2 text-sm font-medium text-white transition hover:border-mrs-button-hover hover:bg-mrs-button-hover" onclick="refreshShipList()">Refresh Ships</button>
                </div>
            </div>
            <p class="mb-5 rounded-lg border border-blue-900 bg-blue-950/50 p-3 text-sm text-gray-300">
                ðŸ’¡ <strong class="text-white">Position numbers (1-9)</strong> are optional and help the Team Lead track who has been in the team longest. Multiple people can have the same number. Drag crew members to reorder or move between ships.
            </p>
            <div id="shipList" class="mb-5 flex flex-col gap-4"></div>
            <button class="rounded-lg border border-mrs-button bg-mrs-button px-5 py-2.5 text-sm font-medium text-white shadow-md transition hover:border-mrs-button-hover hover:bg-mrs-button-hover" onclick="addShip()">+ Add Ship Group</button>
        </div>

        <!-- Preview Card -->
        <div class="rounded-lg border border-gray-700 bg-mrs-box p-5 shadow-lg md:p-6">
            <h2 class="mb-4 font-mohave text-2xl font-semibold uppercase tracking-wide text-white">Preview</h2>
            <div id="preview" class="max-h-96 min-h-[100px] overflow-y-auto rounded-lg border border-gray-700 bg-gray-900 p-4 font-mono text-sm text-gray-300 whitespace-pre-wrap md:p-6">Add ships and crew members to see preview...</div>
            <button class="mt-5 w-full rounded-lg border border-mrs-button bg-mrs-button px-8 py-4 text-lg font-semibold text-white shadow-lg transition hover:border-mrs-button-hover hover:bg-mrs-button-hover" onclick="copyToClipboard()">COPY TO CLIPBOARD</button>
            <!-- Success Message -->
            <div id="successMessage" class="hidden">
                <div class="mt-3 rounded-lg bg-green-600 px-4 py-3 text-center font-medium text-white">
                    âœ… Copied to clipboard!
                </div>
            </div>
        </div>
        </div>
        <!-- END SHIP ASSIGNMENT TAB -->

        <!-- AAR TAB -->
        <div id="content-aar" class="tab-content hidden">
            <div class="mb-6 rounded-lg border border-gray-700 bg-mrs-box p-5 shadow-lg md:p-6">
                <h2 class="mb-4 font-mohave text-2xl font-semibold uppercase tracking-wide text-white">After Action Report</h2>

                <!-- SHIPS USED Section -->
                <div class="mb-6">
                    <h3 class="mb-3 font-mohave text-lg font-semibold uppercase tracking-wide text-blue-300">Ships Used</h3>
                    <div class="grid gap-4 md:grid-cols-2">
                        <!-- Gunship -->
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">Gunship</label>
                            <div class="custom-select-wrapper relative" id="aar-gunship-select">
                                <div class="custom-select-trigger relative flex w-full cursor-pointer items-center justify-between rounded-md border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition hover:border-primary-500">
                                    <span class="custom-select-value truncate pr-4" id="aar-gunship-value">Select ship...</span>
                                    <svg class="custom-select-arrow absolute right-2.5 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="custom-select-dropdown absolute left-0 right-0 top-full z-50 mt-1 hidden overflow-hidden rounded-md border border-gray-600 bg-gray-700 shadow-lg">
                                    <div class="border-b border-gray-600 bg-gray-800 p-2">
                                        <input type="text" placeholder="Search ships..." class="aar-ship-search-input w-full rounded-md border border-gray-600 bg-gray-900 px-3 py-1.5 text-sm text-gray-200 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                                    </div>
                                    <div class="custom-select-options custom-scrollbar max-h-60 overflow-y-auto" id="aar-gunship-options"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Medical -->
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">Medical</label>
                            <div class="custom-select-wrapper relative" id="aar-medical-select">
                                <div class="custom-select-trigger relative flex w-full cursor-pointer items-center justify-between rounded-md border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition hover:border-primary-500">
                                    <span class="custom-select-value truncate pr-4" id="aar-medical-value">Select ship...</span>
                                    <svg class="custom-select-arrow absolute right-2.5 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="custom-select-dropdown absolute left-0 right-0 top-full z-50 mt-1 hidden overflow-hidden rounded-md border border-gray-600 bg-gray-700 shadow-lg">
                                    <div class="border-b border-gray-600 bg-gray-800 p-2">
                                        <input type="text" placeholder="Search ships..." class="aar-ship-search-input w-full rounded-md border border-gray-600 bg-gray-900 px-3 py-1.5 text-sm text-gray-200 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                                    </div>
                                    <div class="custom-select-options custom-scrollbar max-h-60 overflow-y-auto" id="aar-medical-options"></div>
                                </div>
                            </div>
                        </div>

                        <!-- CAP -->
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">CAP Ships <span class="text-xs text-gray-400">(comma-separated if multiple)</span></label>
                            <input type="text" id="aar-cap-ships" placeholder="e.g., Anvil Hornet, Aegis Sabre" class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                        </div>

                        <!-- Additional Ships -->
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">Additional Ships</label>
                            <input type="text" id="aar-additional-ships" placeholder="List additional ships..." class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                        </div>
                    </div>

                    <!-- Reason -->
                    <div class="mt-4">
                        <label class="mb-2 block text-sm font-medium text-gray-300">Reason</label>
                        <input type="text" id="aar-reason" placeholder="e.g., Effectiveness, Required for Situation, Availability..." class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                    </div>
                </div>

                <!-- INTERSYSTEM RESPONSE Section -->
                <div class="mb-6">
                    <label class="mb-2 flex items-center text-sm font-medium text-gray-400">
                        <input type="checkbox" id="aar-intersystem-toggle" class="mr-2 h-4 w-4 rounded border-gray-600 bg-gray-700 text-mrs-button focus:ring-2 focus:ring-mrs-button">
                        Intersystem Response
                    </label>
                </div>

                <!-- LOCATION Section -->
                <div class="mb-6">
                    <h3 class="mb-3 font-mohave text-lg font-semibold uppercase tracking-wide text-blue-300">Location</h3>
                    <div class="grid gap-4 md:grid-cols-2">
                        <!-- Planetary Body -->
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">Planetary Body</label>
                            <div class="custom-select-wrapper relative" id="aar-planet-select">
                                <div class="custom-select-trigger relative flex w-full cursor-pointer items-center justify-between rounded-md border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition hover:border-primary-500">
                                    <span class="custom-select-value truncate pr-4" id="aar-planet-value">Select planetary body...</span>
                                    <svg class="custom-select-arrow absolute right-2.5 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="custom-select-dropdown absolute left-0 right-0 top-full z-50 mt-1 hidden overflow-hidden rounded-md border border-gray-600 bg-gray-700 shadow-lg">
                                    <div class="border-b border-gray-600 bg-gray-800 p-2">
                                        <input type="text" placeholder="Search locations..." class="planet-search-input w-full rounded-md border border-gray-600 bg-gray-900 px-3 py-1.5 text-sm text-gray-200 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                                    </div>
                                    <div class="custom-select-options custom-scrollbar max-h-60 overflow-y-auto" id="aar-planet-options"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Location Type -->
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">Location Type</label>
                            <select id="aar-location-type" class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                                <option value="">Select type...</option>
                                <option value="Landing Zone / City">Landing Zone / City</option>
                                <option value="Settlement">Settlement</option>
                                <option value="Outpost">Outpost</option>
                                <option value="Space Station">Space Station</option>
                                <option value="Lagrange Station">Lagrange Station</option>
                                <option value="Jump Point Station">Jump Point Station</option>
                                <option value="Bunker (Corporate)">Bunker (Corporate)</option>
                                <option value="Bunker (Outlaw)">Bunker (Outlaw)</option>
                                <option value="Bunker (Abandoned)">Bunker (Abandoned)</option>
                                <option value="Security Post">Security Post</option>
                                <option value="Mining Facility">Mining Facility</option>
                                <option value="Processing Facility">Processing Facility</option>
                                <option value="Distribution Center">Distribution Center</option>
                                <option value="Data Center">Data Center</option>
                                <option value="Research Outpost">Research Outpost</option>
                                <option value="Agricultural / Farm">Agricultural / Farm</option>
                                <option value="Aid Shelter">Aid Shelter</option>
                                <option value="Salvage Yard">Salvage Yard</option>
                                <option value="Cave System">Cave System</option>
                                <option value="Derelict / Wreck">Derelict / Wreck</option>
                                <option value="Communication Array">Communication Array</option>
                                <option value="Prison / Rehabilitation">Prison / Rehabilitation</option>
                                <option value="Racetrack">Racetrack</option>
                                <option value="Pickup">Pickup</option>
                                <option value="Stranded">Stranded</option>
                                <option value="Open Space">Open Space</option>
                                <option value="Planet Surface">Planet Surface</option>
                                <option value="PVP Zone">PVP Zone</option>
                                <option value="Other">Other</option>
                            </select>
                            <input type="text" id="aar-location-type-other" placeholder="Specify location type..." class="mt-2 w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 hidden">
                        </div>

                        <!-- Specific POI -->
                        <div class="md:col-span-2">
                            <label class="mb-2 block text-sm font-medium text-gray-300">Specific POI</label>
                            <div class="custom-select-wrapper relative" id="aar-poi-select">
                                <div class="custom-select-trigger relative flex w-full cursor-pointer items-center justify-between rounded-md border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition hover:border-primary-500">
                                    <span class="custom-select-value truncate pr-4" id="aar-poi-value">Select POI...</span>
                                    <svg class="custom-select-arrow absolute right-2.5 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="custom-select-dropdown absolute left-0 right-0 top-full z-50 mt-1 hidden overflow-hidden rounded-md border border-gray-600 bg-gray-700 shadow-lg">
                                    <div class="border-b border-gray-600 bg-gray-800 p-2">
                                        <input type="text" placeholder="Search POIs..." class="poi-search-input w-full rounded-md border border-gray-600 bg-gray-900 px-3 py-1.5 text-sm text-gray-200 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                                    </div>
                                    <div class="custom-select-options custom-scrollbar max-h-60 overflow-y-auto" id="aar-poi-options">
                                        <div class="px-3 py-2 text-sm text-gray-400">Select a planetary body first</div>
                                    </div>
                                </div>
                            </div>
                            <input type="text" id="aar-poi-other" placeholder="Specify POI..." class="mt-2 w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 hidden">
                        </div>
                    </div>
                </div>

                <!-- TIMESTAMPS Section -->
                <div class="mb-6">
                    <h3 class="mb-3 font-mohave text-lg font-semibold uppercase tracking-wide text-blue-300">Timestamps (minutes)</h3>
                    <div class="grid grid-cols-2 gap-4 md:grid-cols-4">
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">Alert</label>
                            <input type="text" id="aar-alert" value="00" class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                        </div>
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">Depart</label>
                            <input type="text" id="aar-depart" placeholder="5" class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                        </div>
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">Client</label>
                            <input type="text" id="aar-client" placeholder="15" class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                        </div>
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">RTB</label>
                            <input type="text" id="aar-rtb" placeholder="25" class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                        </div>
                    </div>
                </div>

                <!-- ENCOUNTERS Section -->
                <div class="mb-6">
                    <h3 class="mb-3 font-mohave text-lg font-semibold uppercase tracking-wide text-blue-300">Encounters</h3>
                    <div class="grid gap-4 md:grid-cols-2">
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">PVE</label>
                            <input type="text" id="aar-pve" placeholder="e.g., NPCs (9Tails), Natural (Freezing Planet), None" class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                        </div>
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">PVP</label>
                            <input type="text" id="aar-pvp" placeholder="e.g., Hostiles, Neutrals, None" class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="mb-2 block text-sm font-medium text-gray-300">Actions Taken</label>
                        <textarea id="aar-actions" rows="3" placeholder="Brief description of tactics and actions..." class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"></textarea>
                    </div>
                </div>

                <!-- ISSUES Section -->
                <div class="mb-6">
                    <h3 class="mb-3 font-mohave text-lg font-semibold uppercase tracking-wide text-blue-300">Issues</h3>
                    <div class="mb-4">
                        <label class="mb-2 block text-sm font-medium text-gray-300">Problems</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="flex items-center rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm transition hover:bg-gray-600">
                                <input type="checkbox" value="Login" class="aar-issue-checkbox mr-2 h-4 w-4 rounded border-gray-600 bg-gray-700 text-mrs-button focus:ring-2 focus:ring-mrs-button">
                                Login
                            </label>
                            <label class="flex items-center rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm transition hover:bg-gray-600">
                                <input type="checkbox" value="Undocking" class="aar-issue-checkbox mr-2 h-4 w-4 rounded border-gray-600 bg-gray-700 text-mrs-button focus:ring-2 focus:ring-mrs-button">
                                Undocking
                            </label>
                            <label class="flex items-center rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm transition hover:bg-gray-600">
                                <input type="checkbox" value="Quantum Travel/Jumpgate" class="aar-issue-checkbox mr-2 h-4 w-4 rounded border-gray-600 bg-gray-700 text-mrs-button focus:ring-2 focus:ring-mrs-button">
                                Quantum Travel/Jumpgate
                            </label>
                            <label class="flex items-center rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm transition hover:bg-gray-600">
                                <input type="checkbox" value="30K" class="aar-issue-checkbox mr-2 h-4 w-4 rounded border-gray-600 bg-gray-700 text-mrs-button focus:ring-2 focus:ring-mrs-button">
                                30K
                            </label>
                            <label class="flex items-center rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm transition hover:bg-gray-600">
                                <input type="checkbox" value="Desync" class="aar-issue-checkbox mr-2 h-4 w-4 rounded border-gray-600 bg-gray-700 text-mrs-button focus:ring-2 focus:ring-mrs-button">
                                Desync
                            </label>
                            <label class="flex items-center rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm transition hover:bg-gray-600">
                                <input type="checkbox" value="Elevators" class="aar-issue-checkbox mr-2 h-4 w-4 rounded border-gray-600 bg-gray-700 text-mrs-button focus:ring-2 focus:ring-mrs-button">
                                Elevators
                            </label>
                            <input type="text" id="aar-other-issues" placeholder="Other issues..." class="rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                        </div>
                    </div>
                    <div>
                        <label class="mb-2 block text-sm font-medium text-gray-300">Brief Fix</label>
                        <textarea id="aar-fix" rows="2" placeholder="Describe how issues were resolved..." class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"></textarea>
                    </div>
                </div>

                <!-- SUMMARY Section -->
                <div class="mb-6">
                    <h3 class="mb-3 font-mohave text-lg font-semibold uppercase tracking-wide text-blue-300">Summary</h3>
                    <textarea id="aar-summary" rows="4" placeholder="Short alert description..." class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"></textarea>
                </div>

                <!-- RESULT Section -->
                <div class="mb-6">
                    <h3 class="mb-3 font-mohave text-lg font-semibold uppercase tracking-wide text-blue-300">Result</h3>
                    <div class="mb-4">
                        <label class="mb-2 block text-sm font-medium text-gray-300">Mission Outcome</label>
                        <select id="aar-outcome" class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                            <option value="">Select...</option>
                            <option value="Success">Success</option>
                            <option value="Failed">Failed</option>
                            <option value="Aborted">Aborted</option>
                            <option value="No Contact">No Contact</option>
                            <option value="Refused">Refused</option>
                            <option value="Game Error">Game Error</option>
                            <option value="Canceled">Canceled</option>
                        </select>
                    </div>
                    <div class="grid gap-4 md:grid-cols-2">
                        <div id="aar-extracted-container" class="hidden">
                            <label class="mb-2 block text-sm font-medium text-gray-300">Client Extracted To</label>
                            <div class="custom-select-wrapper relative" id="aar-extracted-select">
                                <div class="custom-select-trigger relative flex w-full cursor-pointer items-center justify-between rounded-md border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition hover:border-primary-500">
                                    <span class="custom-select-value truncate pr-4" id="aar-extracted-value">Select...</span>
                                    <svg class="custom-select-arrow absolute right-2.5 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="custom-select-dropdown absolute left-0 right-0 top-full z-50 mt-1 hidden overflow-hidden rounded-md border border-gray-600 bg-gray-700 shadow-lg">
                                    <div class="border-b border-gray-600 bg-gray-800 p-2">
                                        <input type="text" placeholder="Search stations..." class="extracted-search-input w-full rounded-md border border-gray-600 bg-gray-900 px-3 py-1.5 text-sm text-gray-200 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                                    </div>
                                    <div class="custom-select-options custom-scrollbar max-h-60 overflow-y-auto" id="aar-extracted-options">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <input type="text" id="aar-extracted-other" placeholder="Specify location..." class="mt-2 w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 hidden">
                        </div>
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">Challenges</label>
                            <select id="aar-challenges" class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                                <option value="">Select...</option>
                                <option value="Abnormal Events">Abnormal Events (e.g., PvP, Hostage)</option>
                                <option value="Routine">Routine (e.g., Standard Bunker Rescue)</option>
                                <option value="Other">Other</option>
                                <option value="None">None</option>
                            </select>
                            <input type="text" id="aar-challenges-other" placeholder="Specify challenges..." class="mt-2 w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 hidden">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="mb-2 block text-sm font-medium text-gray-300">Failure/Abort Reason (if applicable)</label>
                        <input type="text" id="aar-failure" placeholder="Describe reason for failure or abort..." class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                    </div>
                </div>

                <!-- NOTES Section -->
                <div class="mb-6">
                    <h3 class="mb-3 font-mohave text-lg font-semibold uppercase tracking-wide text-blue-300">Notes</h3>
                    <textarea id="aar-notes" rows="4" placeholder="Any additional notes..." class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500"></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button onclick="generateAARPreview()" class="flex-1 rounded-lg border border-mrs-button bg-mrs-button px-6 py-3 font-semibold text-white shadow-md transition hover:border-mrs-button-hover hover:bg-mrs-button-hover">
                        Generate Preview
                    </button>
                    <button onclick="clearAAR()" class="rounded-lg border border-gray-600 bg-gray-700 px-6 py-3 font-semibold text-white transition hover:bg-gray-600">
                        Clear Form
                    </button>
                </div>
            </div>

            <!-- AAR Preview Card -->
            <div class="rounded-lg border border-gray-700 bg-mrs-box p-5 shadow-lg md:p-6">
                <h2 class="mb-4 font-mohave text-2xl font-semibold uppercase tracking-wide text-white">AAR Preview</h2>
                <div id="aar-preview" class="max-h-96 min-h-[100px] overflow-y-auto rounded-lg border border-gray-700 bg-gray-900 p-4 font-mono text-sm text-gray-300 whitespace-pre-wrap md:p-6">Generate AAR to see preview...</div>
                <button class="mt-5 w-full rounded-lg border border-mrs-button bg-mrs-button px-8 py-4 text-lg font-semibold text-white shadow-lg transition hover:border-mrs-button-hover hover:bg-mrs-button-hover" onclick="copyAARToClipboard()">COPY AAR TO CLIPBOARD</button>
                <!-- Success Message -->
                <div id="aar-successMessage" class="hidden">
                    <div class="mt-3 rounded-lg bg-green-600 px-4 py-3 text-center font-medium text-white">
                        âœ… Copied to clipboard!
                    </div>
                </div>
            </div>
        </div>
        <!-- END AAR TAB -->

        <!-- TIP SPLITTER TAB -->
        <div id="content-tipSplitter" class="tab-content hidden">
            <div class="mb-6 rounded-lg border border-gray-700 bg-mrs-box p-5 shadow-lg md:p-6">
                <h2 class="mb-4 font-mohave text-2xl font-semibold uppercase tracking-wide text-white">Tip Splitter Calculator</h2>
                <p class="mb-4 rounded-lg border border-blue-900 bg-blue-950/50 p-3 text-sm text-gray-300">
                    ðŸ’¡ <strong class="text-white">Calculate tip distributions</strong> accounting for the 0.5% transaction fee on each transfer. The calculator ensures the team lead doesn't lose money by including the fee in each transfer amount.
                </p>

                <!-- Input Section -->
                <div class="mb-6">
                    <h3 class="mb-3 font-mohave text-lg font-semibold uppercase tracking-wide text-blue-300">Tip Details</h3>
                    <div class="grid gap-4 md:grid-cols-2">
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">Total Tip Amount (aUEC)</label>
                            <input type="number" id="tip-total" placeholder="100000" min="0" class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                        </div>
                        <div>
                            <label class="mb-2 block text-sm font-medium text-gray-300">
                                Number of Crew Members
                                <span class="text-xs font-normal text-gray-400">(excluding Team Lead)</span>
                            </label>
                            <input type="number" id="tip-recipients" placeholder="5" min="1" class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                            <p class="mt-1 text-xs text-gray-400">Enter the number of crew members who should receive tips (don't count yourself as Team Lead)</p>
                        </div>
                    </div>

                    <!-- Lead Choice Option -->
                    <div class="mt-4">
                        <label class="mb-2 block text-sm font-medium text-gray-300">Your (Team Lead) Choice</label>
                        <select id="tip-lead-choice" class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                            <option value="lead-keep">Keep Tip</option>
                            <option value="lead-decline">Don't Want Tip (Redistribute)</option>
                            <option value="lead-logistics">Donate to Logistics</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-400">Choose what happens to your share. Keep = you get an equal share with no fee. Redistribute = your share goes to crew keeping tips. Logistics = your share goes to logistics pool.</p>
                    </div>

                    <!-- Option: Import from Ship Assignments -->
                    <div class="mt-4">
                        <button onclick="importCrewForTip()" class="rounded-lg border border-gray-600 bg-gray-700 px-4 py-2 text-sm font-medium text-white transition hover:bg-gray-600">
                            Import Crew Count from Ship Assignments
                        </button>
                    </div>
                </div>

                <!-- Recipient Management -->
                <div class="mb-6">
                    <h3 class="mb-3 font-mohave text-lg font-semibold uppercase tracking-wide text-blue-300">Crew Recipients</h3>
                    <p class="mb-3 text-sm text-gray-400">
                        Each crew member (excluding Team Lead) gets an equal share. Choose what happens to each share:
                    </p>
                    <div id="tip-recipients-list" class="mb-3 flex flex-col gap-2">
                        <div class="px-3 py-2 text-sm text-gray-400">Add crew members by entering a number above or importing from ship assignments.</div>
                    </div>
                </div>

                <!-- Calculate Button -->
                <div class="mb-6">
                    <button onclick="calculateTipSplit()" class="w-full rounded-lg border border-mrs-button bg-mrs-button px-8 py-4 text-lg font-semibold text-white shadow-lg transition hover:border-mrs-button-hover hover:bg-mrs-button-hover">
                        CALCULATE SPLITS
                    </button>
                </div>

                <!-- Results Section -->
                <div id="tip-results" class="hidden">
                    <h3 class="mb-3 font-mohave text-lg font-semibold uppercase tracking-wide text-blue-300">Transfer Amounts</h3>
                    <p class="mb-3 text-xs text-gray-400">Type the "Amount to SEND" in-game. They'll receive that exact amount. Star Citizen adds 0.5% fee on top of what you send.</p>
                    <div class="mb-4 rounded-lg border border-gray-700 bg-gray-900 p-4">
                        <div class="mb-3 grid grid-cols-3 gap-4 border-b border-gray-700 pb-2 text-sm font-semibold text-blue-300">
                            <div>Recipient</div>
                            <div class="text-right">Amount to SEND</div>
                            <div class="text-right">They RECEIVE</div>
                        </div>
                        <div id="tip-results-list" class="flex flex-col gap-2"></div>
                        <div id="tip-logistics-transfer" class="hidden mt-3 pt-3 border-t border-yellow-600"></div>
                    </div>

                    <div class="rounded-lg border border-green-900 bg-green-950/50 p-4">
                        <div class="grid gap-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-300">Total Tip:</span>
                                <span class="font-semibold text-white" id="tip-summary-total">0 aUEC</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Total Crew Members:</span>
                                <span class="font-semibold text-white" id="tip-summary-crew-count">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Share Per Crew Member:</span>
                                <span class="font-semibold text-white" id="tip-summary-share">0 aUEC</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">Total Fees (0.5% per transfer):</span>
                                <span class="font-semibold text-red-300" id="tip-summary-fees">0 aUEC</span>
                            </div>
                            <div id="tip-summary-logistics-section" class="hidden flex justify-between border-t border-yellow-800 pt-2">
                                <span class="text-yellow-300">Logistics Pool:</span>
                                <span class="text-lg font-bold text-yellow-300" id="tip-summary-logistics">0 aUEC</span>
                            </div>
                            <div class="flex justify-between border-t border-green-800 pt-2">
                                <span class="text-gray-300">You Will Transfer:</span>
                                <span class="text-lg font-bold text-white" id="tip-summary-transfer">0 aUEC</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-300">You Keep:</span>
                                <span class="text-lg font-bold text-green-300" id="tip-summary-keep">0 aUEC</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END TIP SPLITTER TAB -->
    </div>

    <script>
        // ... (Emoji definitions and all API logic remains unchanged) ...
        // Emoji definitions
        const EMOJIS = {
            header: '<:Medrunner:1054921406091112558>',
            shipTypes: {
                'Gunship': '<:MDRgun:1104388682116518018>',
                'Medship': '<:MDRhug:1127961815977046130>',
                'CAP': '<:MDRknife:1104388679641874522>'
            },
            roles: {
                'PIL': '<:MRS_Pilot:984839934273806356>',
                'LEAD': '<:MRS_Teamlead:1073627559272652820>',
                'MED': '<:MRS_Medical:984839920755568680>',
                'SEC': '<:MRS_Security:984839927604871218>',
                'CAP': '<:CAP:1355255191854645407>'
            },
            positions: {
                1: '<:P1:1432823559364935852>',
                2: '<:P2:1432823555698982973>',
                3: '<:P3:1432823553186861109>',
                4: '<:P4:1432823550997299330>',
                5: '<:P5:1432823547902034010>',
                6: '<:P6:1432823545746161734>',
                7: '<:P7:1432823543518724157>',
                8: '<:P8:1432823540733837342>',
                9: '<:P9:1432823537915396280>'
            }
        };

        // Star Citizen flyable ships list - will be populated from API
        let SHIPS = [];

        // Fallback ship list in case API fails
        const FALLBACK_SHIPS = [
            'Aegis Avenger Titan',
            'Aegis Gladius',
            'Aegis Sabre',
            'Aegis Vanguard Warden',
            'Aegis Hammerhead',
            'Aegis Redeemer',
            'Anvil Arrow',
            'Anvil Carrack',
            'Anvil Paladin',
            'Drake Cutlass Black',
            'Drake Cutlass Red',
            'MISC Freelancer',
            'RSI Apollo Medivac',
            'RSI Apollo Triage',
            'RSI Constellation Andromeda'
        ].sort();

        // Fetch all pages from FleetYards API
        async function fetchAllFleetYardsPages() {
            let allShips = [];
            let page = 1;
            const perPage = 200; // Maximum allowed per page

            try {
                while (true) {
                    const url = `https://api.fleetyards.net/v1/models?page=${page}&perPage=${perPage}`;
                    console.log(`Fetching FleetYards page ${page}...`);

                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        },
                        mode: 'cors',
                    });

                    if (!response.ok) {
                        console.warn(`FleetYards page ${page} returned status ${response.status}`);
                        break;
                    }

                    const data = await response.json();

                    if (!Array.isArray(data) || data.length === 0) {
                        break; // No more data
                    }

                    allShips.push(...data);
                    console.log(`Fetched ${data.length} ships from page ${page}, total: ${allShips.length}`);

                    // If we got less than perPage, we're on the last page
                    if (data.length < perPage) {
                        break;
                    }

                    page++;
                }

                return allShips;
            } catch (error) {
                console.error('Error fetching FleetYards data:', error);
                return null;
            }
        }

        // API endpoints to try (in order)
        const API_SOURCES = [
            {
                name: 'FleetYards',
                fetchData: fetchAllFleetYardsPages,
                parse: (data) => {
                    // Parse the response and extract ship names
                    if (Array.isArray(data)) {
                        return data
                            .filter(ship => {
                                // Filter for flight-ready ships only
                                const status = ship.productionStatus?.toLowerCase() || '';
                                return status === 'flight-ready' || status === 'in-service';
                            })
                            .map(ship => {
                                const manufacturer = ship.manufacturer?.name || ship.manufacturer?.code || '';
                                const name = ship.name || '';
                                return manufacturer ? `${manufacturer} ${name}` : name;
                            })
                            .filter(name => name.trim().length > 0);
                    }
                    return null;
                }
            },
            {
                name: 'FleetYards (All Ships)',
                fetchData: fetchAllFleetYardsPages,
                parse: (data) => {
                    // Fallback: get ALL ships if flight-ready filter returns too few
                    if (Array.isArray(data)) {
                        return data
                            .map(ship => {
                                const manufacturer = ship.manufacturer?.name || ship.manufacturer?.code || '';
                                const name = ship.name || '';
                                return manufacturer ? `${manufacturer} ${name}` : name;
                            })
                            .filter(name => name.trim().length > 0);
                    }
                    return null;
                }
            }
        ];

        // Fetch ships from API
        async function fetchShipsFromAPI() {
            // Check cache first (24 hour expiry)
            const cached = localStorage.getItem('scShipsCache');
            const cacheTime = localStorage.getItem('scShipsCacheTime');

            if (cached && cacheTime) {
                const age = Date.now() - parseInt(cacheTime);
                if (age < 24 * 60 * 60 * 1000) { // 24 hours
                    console.log('Using cached ship list');
                    return JSON.parse(cached);
                }
            }

            // Try each API source
            for (const source of API_SOURCES) {
                try {
                    console.log(`Trying to fetch ships from ${source.name}...`);

                    const data = await source.fetchData();

                    if (data) {
                        console.log(`Received ${data.length} raw ships from ${source.name}`);
                        const ships = source.parse(data);

                        if (ships && ships.length > 0) {
                            const sortedShips = ships.sort();
                            console.log(`âœ… Successfully fetched ${sortedShips.length} ships from ${source.name}`);

                            // Cache the results
                            localStorage.setItem('scShipsCache', JSON.stringify(sortedShips));
                            localStorage.setItem('scShipsCacheTime', Date.now().toString());
                            localStorage.setItem('scShipsSource', source.name);

                            return sortedShips;
                        } else {
                            console.warn(`${source.name} returned no ships after parsing`);
                        }
                    } else {
                        console.warn(`${source.name} returned no data`);
                    }
                } catch (error) {
                    console.warn(`Failed to fetch from ${source.name}:`, error.message);
                }
            }

            // All APIs failed, use fallback
            console.warn('All APIs failed, using fallback ship list');
            return FALLBACK_SHIPS;
        }

        // Update API status indicator
        function updateAPIStatus(status, message, source = '') {
            const statusEl = document.getElementById('apiStatus');
            if (!statusEl) return;

            // Reset classes
            statusEl.className = 'rounded-lg border px-3 py-2 text-xs font-medium flex-1 md:flex-auto';

            // Add appropriate color classes based on status
            if (status === 'success') {
                statusEl.classList.add('border-gray-600', 'bg-gray-700', 'text-gray-300');
            } else if (status === 'error') {
                statusEl.classList.add('border-red-600', 'bg-red-900', 'text-red-200');
            } else { // loading
                statusEl.classList.add('border-gray-600', 'bg-gray-700', 'text-gray-300', 'animate-pulse');
            }

            statusEl.textContent = message + (source ? ` (${source})` : '');
        }

        // Initialize ships on page load
        async function initializeShips() {
            updateAPIStatus('loading', 'Loading ships...');
            SHIPS = await fetchShipsFromAPI();
            console.log(`Loaded ${SHIPS.length} ships`);

            // Determine which source was used
            const source = localStorage.getItem('scShipsSource') || 'unknown';
            const cached = localStorage.getItem('scShipsCache');
            const cacheTime = localStorage.getItem('scShipsCacheTime');

            if (cached && cacheTime) {
                const age = Date.now() - parseInt(cacheTime);
                if (age < 24 * 60 * 60 * 1000 && JSON.parse(cached).length === SHIPS.length) {
                    const hours = Math.floor(age / (60 * 60 * 1000));
                    updateAPIStatus('success', `${SHIPS.length} ships`, `cached ${hours}h ago from ${source}`);
                    return;
                }
            }

            if (SHIPS.length === FALLBACK_SHIPS.length) {
                updateAPIStatus('error', `${SHIPS.length} ships`, 'fallback - API unavailable');
            } else {
                updateAPIStatus('success', `${SHIPS.length} ships`, source);
            }
        }

        // Refresh ship list from API (bypass cache)
        async function refreshShipList() {
            updateAPIStatus('loading', 'Refreshing ships...');

            // Clear cache
            localStorage.removeItem('scShipsCache');
            localStorage.removeItem('scShipsCacheTime');
            localStorage.removeItem('scShipsSource');

            // Fetch fresh data
            SHIPS = await fetchShipsFromAPI();

            const source = localStorage.getItem('scShipsSource') || 'unknown';

            if (SHIPS.length === FALLBACK_SHIPS.length) {
                updateAPIStatus('error', `${SHIPS.length} ships`, 'fallback - API unavailable');
            } else {
                updateAPIStatus('success', `${SHIPS.length} ships refreshed`, source);
            }

            // Re-render any existing ships to update dropdowns
            renderShips();
        }

        // Call initialization
        initializeShips();

        let ships = [];
        let shipIdCounter = 0;

        function addShip() {
            const shipId = shipIdCounter++;

            // Determine ship type based on existing ships
            let shipType = 'Gunship'; // Default first ship

            const hasGunship = ships.some(s => s.type === 'Gunship');
            const hasMedship = ships.some(s => s.type === 'Medship');

            if (hasGunship && !hasMedship) {
                shipType = 'Medship';
            } else if (hasGunship && hasMedship) {
                shipType = 'CAP';
            }

            ships.push({
                id: shipId,
                type: shipType,
                ship: '',
                crew: []
            });
            renderShips();
            updatePreview();
        }

        function removeShip(shipId) {
            ships = ships.filter(s => s.id !== shipId);
            // No position update needed, numbers are sticky
            renderShips();
            updatePreview();
        }

        function addCrewMember(shipId) {
            const ship = ships.find(s => s.id === shipId);
            if (ship) {
                let newRole = 'PIL'; // Default role
                const crewCount = ship.crew.length;

                if (crewCount === 0) {
                    // First crew member logic
                    switch (ship.type) {
                        case 'Gunship':
                            newRole = 'PIL';
                            break;
                        case 'Medship':
                            newRole = 'MED';
                            break;
                        case 'CAP':
                            newRole = 'CAP';
                            break;
                        default:
                            newRole = 'PIL'; // Default to Pilot if type is unknown
                    }
                } else {
                    // Subsequent crew member logic
                    switch (ship.type) {
                        case 'Gunship':
                            const hasLead = ship.crew.some(c => c.role === 'LEAD');
                            if (!hasLead) {
                                newRole = 'LEAD';
                            } else {
                                const hasMed = ship.crew.some(c => c.role === 'MED');
                                if (!hasMed) {
                                    newRole = 'MED';
                                } else {
                                    newRole = 'SEC';
                                }
                            }
                            break;
                        case 'Medship':
                            newRole = 'SEC';
                            break;
                        case 'CAP':
                            newRole = 'SEC'; // Default subsequent CAP to Security
                            break;
                        default:
                            newRole = 'SEC'; // Default all other subsequent to Security
                    }
                }

                // --- New Position Logic ---
                let newPosition = null;
                let highestNumber = 0;
                
                // Find the highest existing number across all ships
                ships.forEach(s => {
                    s.crew.forEach(c => {
                        if (c.position && c.position > highestNumber) {
                            highestNumber = c.position;
                        }
                    });
                });

                // If anyone has a number, set the new one to highest + 1
                if (highestNumber > 0 && highestNumber < 9) {
                    newPosition = highestNumber + 1;
                } else if (highestNumber >= 9) {
                    newPosition = null; // Don't assign if 9 is taken
                }
                // If highestNumber is 0, newPosition remains null (blank)

                ship.crew.push({
                    id: Date.now(),
                    role: newRole, // Use the determined role
                    position: newPosition, // Use the new smart-increment logic
                    name: '',
                    discordId: '',
                    comment: '' // Add new comment field
                });
                renderShips();
                updatePreview();
            }
        }

        function removeCrewMember(shipId, crewId) {
            const ship = ships.find(s => s.id === shipId);
            if (ship) {
                let removedPosition = null;
                const crewMemberToRemove = ship.crew.find(c => c.id === crewId);
                
                if (crewMemberToRemove) {
                    removedPosition = crewMemberToRemove.position; // Get the position, e.g., 3 or null
                }

                // Filter the crew member out
                ship.crew = ship.crew.filter(c => c.id !== crewId);

                // --- NEW SHUFFLE LOGIC ---
                // Only shuffle if the removed member had a valid position
                if (removedPosition) { 
                    // Iterate over ALL ships and ALL crew to find numbers higher than the one removed
                    ships.forEach(s => {
                        s.crew.forEach(c => {
                            if (c.position && c.position > removedPosition) {
                                c.position -= 1; // Shuffle down
                            }
                        });
                    });
                }
                // --- END OF NEW LOGIC ---

                renderShips();
                updatePreview();
            }
        }

        function updateShipType(shipId, type) {
            const ship = ships.find(s => s.id === shipId);
            if (ship) {
                ship.type = type;
                updatePreview();
            }
        }

        function updateShipName(shipId, name) {
            const ship = ships.find(s => s.id === shipId);
            if (ship) {
                ship.ship = name;
                updatePreview();
            }
        }

        function updateCrewRole(shipId, crewId, role) {
            const ship = ships.find(s => s.id === shipId);
            if (ship) {
                const crew = ship.crew.find(c => c.id === crewId);
                if (crew) {
                    crew.role = role;
                    updatePreview();
                }
            }
        }

        function updateCrewPosition(shipId, crewId, position) {
            const ship = ships.find(s => s.id === shipId);
            if (ship) {
                const crew = ship.crew.find(c => c.id === crewId);
                if (crew) {
                    // Store blank as null, otherwise parse as number
                    crew.position = position ? parseInt(position) : null;
                    updatePreview();
                }
            }
        }

        function updateCrewName(shipId, crewId, name) {
            const ship = ships.find(s => s.id === shipId);
            if (ship) {
                const crew = ship.crew.find(c => c.id === crewId);
                if (crew) {
                    crew.name = name;
                    // Name doesn't affect preview, so no need to updatePreview()
                }
            }
        }

        function updateCrewDiscordId(shipId, crewId, discordId) {
            const ship = ships.find(s => s.id === shipId);
            if (ship) {
                const crew = ship.crew.find(c => c.id === crewId);
                if (crew) {
                    crew.discordId = discordId;
                    updatePreview();
                }
            }
        }

        function updateCrewComment(shipId, crewId, comment) {
            const ship = ships.find(s => s.id === shipId);
            if (ship) {
                const crew = ship.crew.find(c => c.id === crewId);
                if (crew) {
                    crew.comment = comment;
                    updatePreview();
                }
            }
        }

        function initializeCustomSelect(selectId, shipId) {
            const wrapper = document.getElementById(selectId);
            if (!wrapper) return;

            const trigger = wrapper.querySelector('.custom-select-trigger');
            const arrow = wrapper.querySelector('.custom-select-arrow');
            const dropdown = wrapper.querySelector('.custom-select-dropdown');
            const searchInput = wrapper.querySelector('.ship-search-input');
            const optionsContainer = wrapper.querySelector('.custom-select-options');
            const valueDisplay = wrapper.querySelector('.custom-select-value');

            // Toggle dropdown
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = !dropdown.classList.contains('hidden');

                // Close all other dropdowns
                document.querySelectorAll('.custom-select-dropdown').forEach(dd => {
                    if (dd !== dropdown) {
                        dd.classList.add('hidden');
                        const otherTrigger = dd.previousElementSibling;
                        otherTrigger.classList.remove('ring-1', 'ring-primary-500', 'border-primary-500');
                        otherTrigger.querySelector('.custom-select-arrow').classList.remove('rotate-180');
                    }
                });

                // Toggle this dropdown
                dropdown.classList.toggle('hidden');
                trigger.classList.toggle('ring-1');
                trigger.classList.toggle('ring-primary-500');
                trigger.classList.toggle('border-primary-500');
                arrow.classList.toggle('rotate-180');

                if (!isOpen) {
                    searchInput.value = ''; // Clear search
                    searchInput.focus();
                    // Show all options
                    optionsContainer.querySelectorAll('.custom-select-option').forEach(opt => opt.classList.remove('hidden'));
                }
            });

            // Search functionality
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                optionsContainer.querySelectorAll('.custom-select-option').forEach(option => {
                    const text = option.textContent.toLowerCase();
                    option.classList.toggle('hidden', !text.includes(searchTerm));
                });
            });

            // Prevent search input from closing dropdown
            searchInput.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // Option selection
            optionsContainer.addEventListener('click', (e) => {
                const option = e.target.closest('.custom-select-option');
                if (!option) return;
                
                const value = option.dataset.value;

                // Update selected state
                optionsContainer.querySelectorAll('.custom-select-option').forEach(opt => {
                    opt.classList.remove('bg-mrs-button', 'text-white');
                });
                option.classList.add('bg-mrs-button', 'text-white');

                // Update display
                valueDisplay.textContent = value;

                // Update ship name
                updateShipName(shipId, value);

                // Close dropdown
                dropdown.classList.add('hidden');
                trigger.classList.remove('ring-1', 'ring-primary-500', 'border-primary-500');
                arrow.classList.remove('rotate-180');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    dropdown.classList.add('hidden');
                    trigger.classList.remove('ring-1', 'ring-primary-500', 'border-primary-500');
                    arrow.classList.remove('rotate-180');
                }
            });
        }

        function renderShips() {
            const container = document.getElementById('shipList');
            container.innerHTML = '';

            ships.forEach((ship) => {
                const shipDiv = document.createElement('div');
                const customSelectId = `custom-select-${ship.id}`;

                // Ship Card
                shipDiv.className = 'rounded-lg border border-gray-700 bg-mrs-box p-4 shadow-md';
                shipDiv.innerHTML = `
                    <div class="mb-3 flex flex-col items-start gap-3 md:flex-row md:items-center md:justify-between">
                        <div class="flex w-full flex-col gap-3 md:w-auto md:flex-row md:items-center">
                            <!-- Ship Type Select -->
                            <select onchange="updateShipType(${ship.id}, this.value)" class="w-full rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-white transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 md:w-auto">
                                ${Object.keys(EMOJIS.shipTypes).map(type =>
                                    `<option value="${type}" ${ship.type === type ? 'selected' : ''}>${type}</option>`
                                ).join('')}
                            </select>
                            
                            <!-- Custom Ship Name Select -->
                            <div class="custom-select-wrapper relative w-full min-w-[250px] md:w-auto" id="${customSelectId}">
                                <div class="custom-select-trigger relative flex w-full cursor-pointer items-center justify-between rounded-md border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition hover:border-primary-500">
                                    <span class="custom-select-value truncate pr-4">${ship.ship || 'Select a ship...'}</span>
                                    <svg class="custom-select-arrow absolute right-2.5 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400 transition-transform duration-200" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="custom-select-dropdown absolute left-0 right-0 top-full z-50 mt-1 hidden overflow-hidden rounded-md border border-gray-600 bg-gray-700 shadow-lg">
                                    <div class="border-b border-gray-600 bg-gray-800 p-2">
                                        <input type="text" placeholder="Search ships..." class="ship-search-input w-full rounded-md border border-gray-600 bg-gray-900 px-3 py-1.5 text-sm text-gray-200 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                                    </div>
                                    <div class="custom-select-options custom-scrollbar max-h-60 overflow-y-auto">
                                        ${SHIPS.map(shipName =>
                                            `<div class="custom-select-option cursor-pointer px-3 py-2 text-sm text-gray-300 hover:bg-mrs-button hover:text-white ${shipName === ship.ship ? 'bg-mrs-button text-white' : ''}" data-value="${shipName}">${shipName}</div>`
                                        ).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="w-full flex-shrink-0 rounded-lg border border-red-600 bg-red-600 px-3 py-2 text-sm font-medium text-white transition hover:bg-red-700 hover:border-red-700 md:w-auto" onclick="removeShip(${ship.id})">Remove Ship</button>
                    </div>
                    
                    <!-- Crew List -->
                    <div id="crew-${ship.id}" data-ship-id="${ship.id}" class="crew-list flex min-h-[50px] flex-col gap-2 rounded-md border-2 border-dashed border-gray-800 p-2"></div>
                    
                    <!-- Add Crew Button -->
                    <button class="mt-3 rounded-lg border border-mrs-button bg-mrs-button px-4 py-2 text-sm font-medium text-white transition hover:border-mrs-button-hover hover:bg-mrs-button-hover" onclick="addCrewMember(${ship.id})">+ Add Crew Member</button>
                `;
                container.appendChild(shipDiv);

                // Initialize custom select
                initializeCustomSelect(customSelectId, ship.id);

                // Render crew members
                const crewContainer = document.getElementById(`crew-${ship.id}`);

                // Allow dropping on empty crew lists
                crewContainer.addEventListener('dragover', handleDragOver);
                crewContainer.addEventListener('drop', handleDropOnEmptyList);

                ship.crew.forEach((crew) => {
                    const crewDiv = document.createElement('div');
                    crewDiv.className = 'crew-member flex flex-wrap cursor-move items-center gap-2 rounded-lg border border-gray-700 bg-mrs-bg p-2 shadow-sm';
                    crewDiv.draggable = true;
                    crewDiv.dataset.crewId = crew.id;
                    crewDiv.innerHTML = `
                        <!-- Position Select (Manual) -->
                        <select onchange="updateCrewPosition(${ship.id}, ${crew.id}, this.value)" class="flex-shrink-0 min-w-[60px] cursor-pointer rounded-lg border border-mrs-button bg-mrs-box px-2 py-2 text-center text-sm font-semibold text-blue-300 transition hover:bg-mrs-button-hover focus:outline-none focus:ring-2 focus:ring-mrs-button">
                            <option value="" ${!crew.position ? 'selected' : ''}>-</option>
                            ${[1, 2, 3, 4, 5, 6, 7, 8, 9].map(num =>
                                `<option value="${num}" ${(crew.position || "") === num ? 'selected' : ''}>${num}</option>`
                            ).join('')}
                        </select>
                        
                        <!-- Role Select -->
                        <select onchange="updateCrewRole(${ship.id}, ${crew.id}, this.value)" class="flex-none min-w-[100px] rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-300 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 md:w-auto">
                            ${Object.keys(EMOJIS.roles).map(role =>
                                `<option value="${role}" ${crew.role === role ? 'selected' : ''}>${role}</option>`
                            ).join('')}
                        </select>
                        
                        <!-- Name Input -->
                        <input type="text" placeholder="Name (optional)"
                               value="${crew.name || ''}"
                               onchange="updateCrewName(${ship.id}, ${crew.id}, this.value)"
                               class="hidden w-36 rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition placeholder:italic placeholder:text-gray-500 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 md:block">
                        
                        <!-- Discord ID Input -->
                        <input type="text" placeholder="Discord ID (e.g., 640...)"
                               value="${crew.discordId}"
                               onchange="updateCrewDiscordId(${ship.id}, ${crew.id}, this.value)"
                               class="flex-1 min-w-[150px] rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition placeholder:text-gray-500 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 md:flex-none md:w-48">
                        
                        <!-- Comment Input -->
                        <input type="text" placeholder="Comment (e.g., Turret)"
                               value="${crew.comment || ''}"
                               onchange="updateCrewComment(${ship.id}, ${crew.id}, this.value)"
                               class="flex-1 min-w-[150px] rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition placeholder:italic placeholder:text-gray-500 focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                        
                        <!-- Remove Crew Button -->
                        <button class="flex-shrink-0 rounded-lg border border-red-600 bg-red-600 px-3 py-2 text-sm font-medium text-white transition hover:bg-red-700 hover:border-red-700" onclick="removeCrewMember(${ship.id}, ${crew.id})">Ã—</button>
                    `;

                    // Drag and drop handlers
                    crewDiv.addEventListener('dragstart', handleDragStart);
                    crewDiv.addEventListener('dragend', handleDragEnd);
                    crewDiv.addEventListener('dragover', handleDragOver);
                    crewDiv.addEventListener('drop', handleDrop);

                    crewContainer.appendChild(crewDiv);
                });
            });
        }

        let draggedElement = null;
        let draggedShipId = null;

        function handleDragStart(e) {
            // Check if the event target is an input or select
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                e.preventDefault();
                return;
            }
            draggedElement = e.target.closest('.crew-member');
            if (!draggedElement) return;

            draggedShipId = parseInt(draggedElement.closest('.crew-list').dataset.shipId);
            // Use setTimeout to allow the browser to render the drag image
            setTimeout(() => {
                draggedElement.classList.add('dragging');
            }, 0);
        }

        function handleDragEnd(e) {
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement = null;
            }
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            if (!draggedElement) return;

            const targetElement = e.target.closest('.crew-member');
            if (targetElement && targetElement !== draggedElement) {
                const targetShipId = parseInt(targetElement.closest('.crew-list').dataset.shipId);
                const draggedShip = ships.find(s => s.id === draggedShipId);
                const targetShip = ships.find(s => s.id === targetShipId);

                const draggedCrewId = parseInt(draggedElement.dataset.crewId);
                const targetCrewId = parseInt(targetElement.dataset.crewId);

                if (draggedShipId === targetShipId) {
                    // Reordering within the same ship
                    const draggedIndex = draggedShip.crew.findIndex(c => c.id === draggedCrewId);
                    const targetIndex = draggedShip.crew.findIndex(c => c.id === targetCrewId);

                    // Swap positions
                    [draggedShip.crew[draggedIndex], draggedShip.crew[targetIndex]] =
                        [draggedShip.crew[targetIndex], draggedShip.crew[draggedIndex]];
                } else {
                    // Moving crew member to a different ship
                    const draggedCrewIndex = draggedShip.crew.findIndex(c => c.id === draggedCrewId);
                    const targetCrewIndex = targetShip.crew.findIndex(c => c.id === targetCrewId);

                    // Remove from original ship
                    const crewMember = draggedShip.crew.splice(draggedCrewIndex, 1)[0];

                    // Insert into target ship at target position
                    targetShip.crew.splice(targetCrewIndex, 0, crewMember);
                }
                
                // No position update needed, numbers are sticky
                renderShips();
                updatePreview();
            }
        }

        function handleDropOnEmptyList(e) {
            e.preventDefault();
            if (!draggedElement) return;

            // Only handle if dropped on the crew list itself, not on a crew member
            if (e.target.classList.contains('crew-list')) {
                const targetShipId = parseInt(e.target.dataset.shipId);
                const draggedShip = ships.find(s => s.id === draggedShipId);
                const targetShip = ships.find(s => s.id === targetShipId);

                // Only move if dragging to a different ship
                if (draggedShipId !== targetShipId) {
                    const draggedCrewId = parseInt(draggedElement.dataset.crewId);
                    const draggedCrewIndex = draggedShip.crew.findIndex(c => c.id === draggedCrewId);

                    // Remove from original ship
                    const crewMember = draggedShip.crew.splice(draggedCrewIndex, 1)[0];

                    // Add to end of target ship
                    targetShip.crew.push(crewMember);

                    // No position update needed
                    renderShips();
                    updatePreview();
                }
            }
        }

        function generateOutput() {
            // Generate UTC timestamp for Discord relative time
            const timestamp = Math.floor(Date.now() / 1000);

            let output = `# __${EMOJIS.header}SHIP ASSIGNMENTS${EMOJIS.header}__\n\n`;

            ships.forEach(ship => {
                if (ship.crew.length > 0) {
                    const shipTypeEmoji = EMOJIS.shipTypes[ship.type] || 'ðŸš€';
                    output += `## __**${ship.type}**__ ${shipTypeEmoji} ${ship.ship}\n`;

                    ship.crew.forEach(crew => {
                        const roleEmoji = EMOJIS.roles[crew.role] || 'ðŸ‘¤';
                        const mention = crew.discordId ? `<@${crew.discordId}>` : '[No Discord ID]';
                        
                        let positionText = '';
                        if (crew.position) {
                            const positionEmoji = EMOJIS.positions[crew.position] || crew.position;
                            positionText = ` ${positionEmoji}`; // Only add if position is set
                        }
                        
                        let commentText = '';
                        if (crew.comment && crew.comment.trim() !== '') {
                            commentText = ` (${crew.comment.trim()})`; // Add leading space and parenthesis
                        }
                        
                        output += `> ${roleEmoji} - ${mention}${positionText}${commentText}\n`;
                    });

                    output += '\n';
                }
            });

            // Add timestamp at the end in smaller text
            output += `-# Updated <t:${timestamp}:R>`;

            return output;
        }

        function updatePreview() {
            const preview = document.getElementById('preview');
            if (ships.length === 0 || ships.every(s => s.crew.length === 0)) {
                preview.textContent = 'Add ships and crew members to see preview...';
            } else {
                preview.textContent = generateOutput();
            }
        }

        function copyToClipboard() {
            const output = generateOutput();

            // Use execCommand as a fallback for clipboard API
            if (!navigator.clipboard) {
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = output;
                    textArea.style.position = 'fixed'; // Prevent scrolling to bottom
                    textArea.style.top = '0';
                    textArea.style.left = '0';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showSuccessMessage();
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    alert('Failed to copy to clipboard. Please try again.');
                }
                return;
            }

            navigator.clipboard.writeText(output).then(() => {
                showSuccessMessage();
            }).catch(err => {
                alert('Failed to copy to clipboard. Please try again.');
                console.error('Failed to copy:', err);
            });
        }
        
        function showSuccessMessage() {
            const successMessage = document.getElementById('successMessage');
            successMessage.classList.remove('hidden');
            setTimeout(() => {
                successMessage.classList.add('hidden');
            }, 3000);
        }

        // Initialize with empty state
        renderShips();

        // ===== IMPORT FROM DISCORD FUNCTIONALITY =====

        // Reverse emoji mapping for parsing
        const EMOJI_TO_ROLE = {};
        Object.entries(EMOJIS.roles).forEach(([role, emoji]) => {
            EMOJI_TO_ROLE[emoji] = role;
        });

        const EMOJI_TO_POSITION = {};
        Object.entries(EMOJIS.positions).forEach(([num, emoji]) => {
            EMOJI_TO_POSITION[emoji] = parseInt(num);
        });

        const EMOJI_TO_SHIP_TYPE = {};
        Object.entries(EMOJIS.shipTypes).forEach(([type, emoji]) => {
            EMOJI_TO_SHIP_TYPE[emoji] = type;
        });

        function importFromDiscord() {
            const message = document.getElementById('import-discord-message').value;
            const statusEl = document.getElementById('import-status');

            if (!message.trim()) {
                showImportStatus('error', 'Please paste a Discord message first.');
                return;
            }

            try {
                // Parse the Discord message
                const parsedShips = parseDiscordMessage(message);

                if (parsedShips.length === 0) {
                    showImportStatus('error', 'No ships found in the message. Make sure it\'s a valid ship assignment message.');
                    return;
                }

                // Clear existing ships and populate with parsed data
                ships = parsedShips;
                shipIdCounter = Math.max(...ships.map(s => s.id), 0) + 1;

                renderShips();
                updatePreview();

                showImportStatus('success', `Successfully imported ${parsedShips.length} ship(s) with ${parsedShips.reduce((sum, s) => sum + s.crew.length, 0)} crew member(s)!`);

                // Clear the import textarea
                document.getElementById('import-discord-message').value = '';
            } catch (error) {
                console.error('Import error:', error);
                showImportStatus('error', 'Failed to parse message: ' + error.message);
            }
        }

        function parseDiscordMessage(message) {
            const parsedShips = [];
            let currentShipId = 0;

            // Split message into lines
            const lines = message.split('\n');

            let currentShip = null;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // Skip empty lines
                if (!line) {
                    continue;
                }

                // Skip main header (starts with single #)
                if (line.match(/^#\s+__/)) {
                    continue;
                }

                // Skip footer (starts with -#)
                if (line.startsWith('-#')) {
                    continue;
                }

                // Check if line is a ship header: ## __**{Type}**__ {emoji} {ship name}
                // More flexible regex to capture ship name after emoji
                const shipMatch = line.match(/^##\s*__\*\*(.+?)\*\*__\s*<:[^>]+>\s+(.+)$/);
                if (shipMatch) {
                    const shipType = shipMatch[1].trim();
                    const shipName = shipMatch[2].trim();

                    // If we have a current ship, save it
                    if (currentShip) {
                        parsedShips.push(currentShip);
                    }

                    // Start a new ship
                    currentShip = {
                        id: currentShipId++,
                        type: shipType,
                        ship: shipName,
                        crew: []
                    };
                    continue;
                }

                // Check if line is a crew member: > {roleEmoji} - <@{discordId}> {position?} {comment?}
                const crewMatch = line.match(/^>\s*(<:[^>]+>)\s*-\s*<@(\d+)>\s*(.*)/);
                if (crewMatch && currentShip) {
                    const roleEmoji = crewMatch[1];
                    const discordId = crewMatch[2];
                    const remainder = crewMatch[3].trim();

                    // Find role from emoji
                    const role = EMOJI_TO_ROLE[roleEmoji] || 'PIL';

                    // Parse position and comment from remainder
                    let position = null;
                    let comment = '';

                    // Try to find position emoji (with <: brackets)
                    for (const [emoji, num] of Object.entries(EMOJI_TO_POSITION)) {
                        if (remainder.includes(emoji)) {
                            position = num;
                            // Remove position emoji from remainder to get comment
                            const parts = remainder.replace(emoji, '').trim();
                            // Extract comment from parentheses if present
                            const commentMatch = parts.match(/\(([^)]+)\)/);
                            if (commentMatch) {
                                comment = commentMatch[1].trim();
                            }
                            break;
                        }
                    }

                    // Try to find position without <: brackets (e.g., :P5:)
                    if (!position) {
                        const barePositionMatch = remainder.match(/:P(\d):/);
                        if (barePositionMatch) {
                            position = parseInt(barePositionMatch[1]);
                            // Remove position from remainder to get comment
                            const parts = remainder.replace(barePositionMatch[0], '').trim();
                            // Extract comment from parentheses if present
                            const commentMatch = parts.match(/\(([^)]+)\)/);
                            if (commentMatch) {
                                comment = commentMatch[1].trim();
                            }
                        }
                    }

                    // If no position found, check for comment anyway
                    if (!position) {
                        const commentMatch = remainder.match(/\(([^)]+)\)/);
                        if (commentMatch) {
                            comment = commentMatch[1].trim();
                        }
                    }

                    currentShip.crew.push({
                        id: Date.now() + Math.random(), // Unique ID
                        role: role,
                        position: position,
                        name: '',
                        discordId: discordId,
                        comment: comment
                    });
                }
            }

            // Don't forget to add the last ship
            if (currentShip) {
                parsedShips.push(currentShip);
            }

            return parsedShips;
        }

        function showImportStatus(type, message) {
            const statusEl = document.getElementById('import-status');
            statusEl.className = 'mt-3 rounded-lg px-4 py-3 text-center font-medium';

            if (type === 'success') {
                statusEl.classList.add('bg-green-600', 'text-white');
            } else {
                statusEl.classList.add('bg-red-600', 'text-white');
            }

            statusEl.textContent = message;
            statusEl.classList.remove('hidden');

            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 5000);
        }

        // ===== AAR FUNCTIONALITY =====

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active state from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-mrs-button', 'text-white');
                button.classList.add('border-transparent', 'text-gray-400');
            });

            // Show selected tab content
            document.getElementById('content-' + tabName).classList.remove('hidden');

            // Add active state to selected tab
            const activeTab = document.getElementById('tab-' + tabName);
            activeTab.classList.add('active', 'border-mrs-button', 'text-white');
            activeTab.classList.remove('border-transparent', 'text-gray-400');

            // If switching to AAR tab, populate ship dropdowns and re-initialize location dropdowns
            if (tabName === 'aar') {
                populateAARShipDropdowns();
                // Re-initialize planet and POI dropdowns to ensure event listeners are attached
                if (PLANETARY_BODIES.length > 0) {
                    initializeAARPlanetSelect();
                }
                initializeAARPOISelect();
            }
        }

        // Locations database - embedded to avoid CORS issues with file:// protocol
        const LOCATIONS_DATABASE_DATA = {"systems":{"STANTON":{"name":"Stanton","jumpPointStations":["Pyro Gateway"],"planets":{"HURSTON":{"name":"Hurston","designation":"Stanton I","type":"planet","landingZones":["Lorville"],"settlements":["Cutter's Rig","Finn's Folly","Ludlow","Maker's Point","Picker's Field","Rappel","Weeping Cove","Zephyr"],"pois":["HDMS-Edmond","HDMS-Hadley","HDMS-Oparei","HDMS-Pinewood","HDMS-Stanhope","HDMS-Thedus","HDSF-Adlai","HDSF-Barnabas","HDSF-Breckinridge","HDSF-Colfax","HDSF-Damaris","HDSF-Elbridge","HDSF-Hendricks","HDSF-Hiram","HDSF-Hobart","HDSF-Ishmael","HDSF-Millerand","HDSF-Rufus","HDSF-Sherman","HDSF-Tamar","HDSF-Tompkins","HDSF-Zacharias","Reclamation & Disposal Orinth","HDMO-Calthrope","Downed Relay AC-652","Rico's Remains","Lowdown","Trilo","Broken Patch","Echo Island"],"stations":["Everus Harbor"],"lagrangeStations":["HUR-L1 (Rest & Relax)","HUR-L2 (Faithful Dream)","HUR-L3 (Thundering Express)","HUR-L4 (Ambitious Dream)","HUR-L5 (Beautiful Glen)"],"moons":{"ARIAL":{"name":"Arial","designation":"Stanton 1a","pois":["HDMS-Bezdek","HDMS-Lathan","CommArray ST1-13","Coven","Onyx Facility S1A8","Smokestack","The Dregs"]},"ABERDEEN":{"name":"Aberdeen","designation":"Stanton 1b","pois":["HDMS-Anderson","HDMS-Norgaard","Klescher Rehabilitation Facility","Barton Flats Aid Shelter","HDMO-Dobbs","CommArray ST1-92"]},"MAGDA":{"name":"Magda","designation":"Stanton 1c","pois":["HDMS-Hahn","HDMS-Perlman","CommArray ST1-48"]},"ITA":{"name":"Ita","designation":"Stanton 1d","pois":["HDMS-Woodruff","HDMS-Ryder","The Shades","Thimblerig","CommArray ST1-13"]}}},"CRUSADER":{"name":"Crusader","designation":"Stanton II","type":"gas_giant","landingZones":["Orison"],"settlements":["Cloudrest Retreat","Empyrean Park","Prospect Point"],"stations":["Port Olisar","Security Post Kareah","Seraphim Station","CommArray ST2-55"],"lagrangeStations":["CRU-L1 (Ambitious Dream)","CRU-L4 (Shallow Frontier)","CRU-L5 (Beautiful Glen)"],"moons":{"CELLIN":{"name":"Cellin","designation":"Stanton 2a","pois":["Gallete Family Farms","Terra Mills HydroFarm","Tram & Myers Mining","Hickes Research Outpost","Security Post Criska","Security Post Dipur","Security Post Lespin","Ashburn Channel Aid Shelter","Flanagan's Ravine Aid Shelter","Julep Ravine Aid Shelter","Mogote Aid Shelter","NT-999-XV","Stash House (Cellin)","Unnamed Abandoned Outpost","CommArray ST2-28"]},"DAYMAR":{"name":"Daymar","designation":"Stanton 2b","pois":["Bountiful Harvest Hydroponics","ArcCorp Mining Area 141","Kudre Ore","Shubin Mining Facility SCD-1","Security Post Moluto","Security Post Prashad","Security Post Thaquray","NT-999-XVI","The Garden","TPF","Wailing Rock","Kudre Ore Mine (Closed)","Dunlow Ridge Aid Shelter","Eager Flats Aid Shelter","Tamdon Plains Aid Shelter","Wolf Point Aid Shelter","Brio's Breaker Yard","Whistlers Crypt","Yadar Valley","Nuen Waste Management","UEES Flyssa Wreck","Covalex Hub Gundo","CommArray ST2-47"]},"YELA":{"name":"Yela","designation":"Stanton 2c","pois":["Abandoned Outpost (Mining Facility)","ArcCorp Mining Area 157","Benson Mining Outpost","Deakins Research Outpost","Jumptown","Security Post Opal","Security Post Wan","Aston Ridge Aid Shelter","Kosso Basin Aid Shelter","Nakamura Valley Aid Shelter","Talarine Divide Aid Shelter","Afterlife","Connor's","Utopia","NT-999-XX","NT-999-XXII","Half Stack","Mainline","Miner's Lament","Rolo's Crater","Benny Henge","CommArray ST2-76"],"stations":["GrimHEX"]}}},"ARCCORP":{"name":"ArcCorp","designation":"Stanton III","type":"planet","landingZones":["Area 18"],"settlements":["Area04","Area06","Area07","Area11","Area17","Area20","Area26","Area39"],"pois":["The Sky Scraper","Ermer Family Farms Creamery","CommArray ST3-90"],"stations":["Baijini Point"],"lagrangeStations":["ARC-L1 (Wide Forest)","ARC-L2 (Lively Pathway)","ARC-L3 (Modern Icarus)","ARC-L4 (Faint Glen)","ARC-L5 (Stately Home)"],"moons":{"LYRIA":{"name":"Lyria","designation":"Stanton 3a","pois":["Humboldt Mines","Loveridge Mineral Reserve","Shubin Mining Facility SAL-2","Shubin Mining Facility SAL-5","Shubin Processing Facility SPAL-3","Shubin Processing Facility SPAL-7","Shubin Processing Facility SPAL-9","Shubin Processing Facility SPAL-12","Shubin Processing Facility SPAL-16","Shubin Processing Facility SPAL-21","Security Depot Lyria-1","Elsewhere","Teddy's Playhouse","The Orphanage","The Pit","Wheeler's","Paradise Cove","Buckets","Launch Pad","CommArray ST3-18"]},"WALA":{"name":"Wala","designation":"Stanton 3b","pois":["Shady Glen Farms","ArcCorp Mining Area 045","ArcCorp Mining Area 048","ArcCorp Mining Area 056","ArcCorp Mining Area 061","ArcCorp Processing Center 115","ArcCorp Processing Center 123","Lost and Found","Good Times Temple","Samson & Sons Salvage Center","CommArray ST3-35"]}}},"MICROTECH":{"name":"microTech","designation":"Stanton IV","type":"planet","landingZones":["New Babbage"],"settlements":["Astor's Clearing","Bloodshot Ridge","Dunboro","Frostbite","Ghost Hollow","Harper's Point","Moreland Hills","Razor's Edge"],"pois":["MT DataCenter 2UB-RB9-5","MT DataCenter 4HJ-LVE-A","MT DataCenter 5WQ-R2V-C","MT DataCenter 8FK-Q2X-K","MT DataCenter D79-ECG-R","MT DataCenter E2Q-NSG-Y","MT DataCenter TMG-XEV-2","MT DataCenter QVX-J88-J","MT DataCenter L8P-JUC-8","MT DataCenter KH3-AAE-L","Calhoun Pass Emergency Shelter","Point Wain Emergency Shelter","Nuiqsut Emergency Shelter","Clear View Emergency Shelter","Shubin Mining Facility SM0-10","Shubin Mining Facility SM0-13","Shubin Mining Facility SM0-18","Shubin Mining Facility SM0-22","Rayari Deltana Research Outpost","Rayari Livengood Research Outpost","MT OpCenter LTI-4","Outpost 54","The Necropolis","Covalex Distribution Centre S4DC05","Greycat Stanton IV Production Complex-A","Cry-Astro Processing Plant 34-12","Cry-Astro Processing Plant 19-02","MicroTech Logistics Depot S4LD01","MicroTech Logistics Depot S4LD13","Sakura Sun Goldenrod Workcenter"],"stations":["Port Tressler"],"lagrangeStations":["MIC-L1 (Shallow Frontier)","MIC-L2 (Long Forest)","MIC-L3 (Endless Odyssey)","MIC-L4 (Melodic Fields)","MIC-L5 (Shady Stockade)"],"moons":{"CALLIOPE":{"name":"Calliope","designation":"Stanton 4a","pois":["Shubin Mining Facility SMCa-6","Shubin Mining Facility SMCa-8","Shubin Processing Facility SPMC-1","Shubin Processing Facility SPMC-3","Shubin Processing Facility SPMC-5","Shubin Processing Facility SPMC-10","Shubin Processing Facility SPMC-11","Shubin Processing Facility SPMC-14","Rayari Anvik Research Outpost","Rayari Kaltag Research Outpost","Raven's Roost","CommArray ST4-31","Blighter's Run","Hard Knocks","Hasbin Hall","Regiment Downs"]},"CLIO":{"name":"Clio","designation":"Stanton 4b","pois":["Rayari Cantwell Research Outpost","Rayari McGrath Research Outpost","CommArray ST4-59"]},"EUTERPE":{"name":"Euterpe","designation":"Stanton 4c","pois":["Bud's Growery","The Icebreaker","Devlin Scrap & Salvage","CommArray ST4-64"]}}}}},"PYRO":{"name":"Pyro","jumpPointStations":["Stanton Gateway"],"planets":{"PYRO1":{"name":"Pyro I","designation":"Pyro I","type":"planet","pois":["Gray Gardens Depot","Rustville","Stag's Rut","Lazarus Phoenix Research Lab","Lazarus Tithonus Research Lab","Lazarus Transport Hub Phoenix-I","Lazarus Transport Hub Phoenix-II","Lazarus Transport Hub Phoenix-III","Lazarus Transport Hub Tithonus-I","Lazarus Transport Hub Tithonus-II","Lazarus Transport Hub Tithonus-III"],"lagrangeStations":["PYAM-FARSTAT-1-2 (L2)","PYAM-FARSTAT-1-3 (L3 - Akiro Cluster)","PYAM-FARSTAT-1-5 (L5)"]},"MONOX":{"name":"Monox","designation":"Pyro II","type":"planet","pois":["Arid Reach","Jackson's Swap","Last Ditch","Ostler's Claim","Slowburn Depot","Sunset Mesa","Yang's Place"],"lagrangeStations":["Checkmate Station (L4)"]},"BLOOM":{"name":"Bloom","designation":"Pyro III","type":"planet","pois":["Bueno Ravine","Frigid Knot","Narena's Rest","Shepherd's Rest","Carver's Ridge","The Golden Riviera","The Yard","Windfall","Shadowfall","Prospect Depot"],"stations":["Orbituary"],"lagrangeStations":["Starlight Service Station (L1)","PYAM-FARSTAT-3-2 (L2)","Patch City (L3)","PYAM-FARSTAT-3-4 (L4)","PYAM-FARSTAT-3-5 (L5)"]},"PYRO4":{"name":"Pyro IV","designation":"Pyro IV","type":"planet","pois":["Sacren's Plot","Chawla's Beach","Dinger's Depot","Fallow Field","Farro Data Center I","Farro Data Center II","Farro Data Center III","Farro Data Center IV","Farro Data Center V","Farro Data Center VI","Farro Data Center VII","Farro Data Center VIII","Farro Data Center IX","Farro Data Center X","Goner's Deal"]},"PYRO5":{"name":"Pyro V","designation":"Pyro V","type":"gas_giant","lagrangeStations":["PYAM-FARSTAT-5-1 (L1)","Gaslight (L2)","PYAM-FARSTAT-5-3 (L3)","Rod's Fuel 'N Supplies (L4)","Rat's Nest (L5)"],"moons":{"IGNIS":{"name":"Ignis","designation":"Pyro 5a","pois":["Ashland","Kabir's Post"]},"VATRA":{"name":"Vatra","designation":"Pyro 5b","pois":["Seer's Canyon"]},"ADIR":{"name":"Adir","designation":"Pyro 5c","pois":["Prophet's Peak","Derelict Outpost","Obsidian Crack"]},"FAIRO":{"name":"Fairo","designation":"Pyro 5d","pois":["Outpost 08P","FEO Canyon Depot","YW-2455-WS"]},"FUEGO":{"name":"Fuego","designation":"Pyro 5e","pois":["RAB-Lamda","RAB-Over","RAB-Victory"]},"VUUR":{"name":"Vuur","designation":"Pyro 5f","pois":[]}}},"TERMINUS":{"name":"Terminus","designation":"Pyro VI","type":"planet","pois":["Blackrock Exchange","Bullock's Reach","Canard View","Kinder Plots","Last Landings","Rough Landing","Scarper's Turn","Stonetree","Supply Gap","Watcher's Depot"],"stations":["Ruin Station"],"lagrangeStations":["PYAM-FARSTAT-6-2 (L2)","Endgame (L3)","Dudley & Daughters (L4)","Megumi Refueling (L5)"]}}}},"locationTypes":{"city":"Landing Zone / City","settlement":"Settlement / Outpost","station":"Space Station","lagrange":"Lagrange Station","mining":"Mining Facility / Outpost","processing":"Processing Facility","research":"Research Outpost","security":"Security Post / Bunker","distribution":"Distribution Center","data":"Data Center","farm":"Agricultural / Farm","shelter":"Aid Shelter / Emergency Shelter","salvage":"Salvage Yard","cave":"Cave System","wreck":"Derelict / Wreck","racetrack":"Racetrack","prison":"Prison / Rehabilitation Facility","commarray":"Communication Array","other":"Other Point of Interest"}};

        let LOCATIONS_DATABASE = null;
        let PLANETARY_BODIES = [];
        let PLANETARY_BODY_TO_POIS = {};

        // Load locations database (now using embedded data)
        async function loadLocationsDatabase() {
            return LOCATIONS_DATABASE_DATA;
        }

        // Initialize planetary bodies from database
        async function initializePlanetaryBodies() {
            LOCATIONS_DATABASE = await loadLocationsDatabase();

            if (!LOCATIONS_DATABASE) {
                console.warn('Locations database not available');
                return;
            }

            // Build planetary bodies list and POI mappings
            const bodies = [];
            PLANETARY_BODY_TO_POIS = {};

            // Process each system
            for (const [systemKey, systemData] of Object.entries(LOCATIONS_DATABASE.systems)) {
                // Add jump point stations as a special category
                if (systemData.jumpPointStations && systemData.jumpPointStations.length > 0) {
                    const jumpPointName = `Jump Points (${systemData.name})`;
                    bodies.push({
                        name: jumpPointName,
                        designation: 'System Jump Points',
                        system: systemData.name,
                        isJumpPoint: true
                    });
                    PLANETARY_BODY_TO_POIS[jumpPointName] = systemData.jumpPointStations;
                }

                // Process each planet
                for (const [planetKey, planetData] of Object.entries(systemData.planets)) {
                    const planetName = planetData.name;
                    bodies.push({
                        name: planetName,
                        designation: planetData.designation || '',
                        system: systemData.name
                    });

                    // Collect all POIs for this planet
                    const pois = [
                        ...(planetData.landingZones || []),
                        ...(planetData.settlements || []),
                        ...(planetData.pois || []),
                        ...(planetData.stations || []),
                        ...(planetData.lagrangeStations || [])
                    ];

                    PLANETARY_BODY_TO_POIS[planetName] = pois;

                    // Process moons
                    if (planetData.moons) {
                        for (const [moonKey, moonData] of Object.entries(planetData.moons)) {
                            const moonName = moonData.name;
                            bodies.push({
                                name: moonName,
                                designation: moonData.designation || '',
                                system: systemData.name,
                                parent: planetName
                            });

                            // Collect POIs for this moon
                            const moonPois = [
                                ...(moonData.landingZones || []),
                                ...(moonData.settlements || []),
                                ...(moonData.pois || []),
                                ...(moonData.stations || [])
                            ];

                            PLANETARY_BODY_TO_POIS[moonName] = moonPois;
                        }
                    }
                }
            }

            // Sort bodies by system, then by name
            bodies.sort((a, b) => {
                if (a.system !== b.system) {
                    return a.system.localeCompare(b.system);
                }
                return a.name.localeCompare(b.name);
            });

            PLANETARY_BODIES = bodies;
            populateAARPlanetDropdown();
            initializeAARPOISelect(); // Initialize POI dropdown even if empty
            populateExtractedToDropdown(); // Populate "Client Extracted To" dropdown
        }

        // Populate AAR ship dropdowns from current ship assignments
        function populateAARShipDropdowns() {
            const assignedShips = ships.map(s => s.ship).filter(s => s && s.trim() !== '');

            // Get unique ships (in case of duplicates)
            const uniqueShips = [...new Set(assignedShips)];

            // Populate each ship dropdown (CAP is now a text input, not dropdown)
            populateAARShipDropdown('aar-gunship', uniqueShips);
            populateAARShipDropdown('aar-medical', uniqueShips);
        }

        function populateAARShipDropdown(selectId, assignedShips) {
            const optionsContainer = document.getElementById(selectId + '-options');
            if (!optionsContainer) {
                console.warn('Options container not found for:', selectId);
                return;
            }

            let options = '';

            // Add assigned ships first if any
            if (assignedShips.length > 0) {
                options += '<div class="px-3 py-2 text-xs font-semibold uppercase text-blue-300 bg-gray-800">From Assignments</div>';
                assignedShips.forEach(ship => {
                    options += `<div class="custom-select-option cursor-pointer px-3 py-2 text-sm text-gray-300 hover:bg-mrs-button hover:text-white" data-value="${ship}">${ship}</div>`;
                });
                options += '<div class="border-t border-gray-600 my-1"></div>';
                options += '<div class="px-3 py-2 text-xs font-semibold uppercase text-blue-300 bg-gray-800">All Ships</div>';
            }

            // Add all ships from SHIPS array
            SHIPS.forEach(ship => {
                options += `<div class="custom-select-option cursor-pointer px-3 py-2 text-sm text-gray-300 hover:bg-mrs-button hover:text-white" data-value="${ship}">${ship}</div>`;
            });

            optionsContainer.innerHTML = options;

            // Wait a tick for DOM to update, then initialize the select
            setTimeout(() => {
                initializeAARSelect(selectId);
            }, 0);
        }

        function populateAARPlanetDropdown() {
            const optionsContainer = document.getElementById('aar-planet-options');
            if (!optionsContainer) {
                console.warn('Planet options container not found');
                return;
            }

            if (PLANETARY_BODIES.length === 0) {
                optionsContainer.innerHTML = '<div class="px-3 py-2 text-sm text-gray-400">Loading locations...</div>';
                return;
            }

            let options = '';
            let currentSystem = '';

            PLANETARY_BODIES.forEach(body => {
                // Add system header if changed
                if (body.system !== currentSystem) {
                    if (currentSystem !== '') {
                        options += '<div class="border-t border-gray-600 my-1"></div>';
                    }
                    options += `<div class="px-3 py-2 text-xs font-semibold uppercase text-blue-300 bg-gray-800">${body.system} System</div>`;
                    currentSystem = body.system;
                }

                const displayText = body.designation ? `${body.name} (${body.designation})` : body.name;
                options += `<div class="custom-select-option cursor-pointer px-3 py-2 text-sm text-gray-300 hover:bg-mrs-button hover:text-white" data-value="${body.name}">${displayText}</div>`;
            });

            optionsContainer.innerHTML = options;

            // Wait a tick for DOM to update, then initialize the select
            setTimeout(() => {
                initializeAARPlanetSelect();
            }, 0);
        }

        // Populate POI dropdown based on selected planet
        function populateAARPOIDropdown(planetName) {
            const optionsContainer = document.getElementById('aar-poi-options');
            if (!optionsContainer) {
                console.warn('POI options container not found');
                return;
            }

            const pois = PLANETARY_BODY_TO_POIS[planetName];

            if (!pois || pois.length === 0) {
                optionsContainer.innerHTML = '<div class="px-3 py-2 text-sm text-gray-400">No POIs available for this location</div>';
                return;
            }

            let options = '';
            pois.forEach(poi => {
                options += `<div class="custom-select-option cursor-pointer px-3 py-2 text-sm text-gray-300 hover:bg-mrs-button hover:text-white" data-value="${poi}">${poi}</div>`;
            });

            // Add "Other" option at the end
            options += `<div class="custom-select-option cursor-pointer px-3 py-2 text-sm text-gray-300 hover:bg-mrs-button hover:text-white border-t border-gray-600 mt-1 pt-2" data-value="Other">Other (specify below)</div>`;

            optionsContainer.innerHTML = options;

            // Wait a tick for DOM to update, then initialize the select
            setTimeout(() => {
                initializeAARPOISelect();
            }, 0);
        }

        // Initialize AAR ship select
        function initializeAARSelect(selectId) {
            const wrapper = document.getElementById(selectId + '-select');
            if (!wrapper) return;

            const trigger = wrapper.querySelector('.custom-select-trigger');
            const dropdown = wrapper.querySelector('.custom-select-dropdown');
            const searchInput = wrapper.querySelector('.aar-ship-search-input');
            const optionsContainer = wrapper.querySelector('.custom-select-options');

            // Clear existing event listeners by cloning elements
            const newTrigger = trigger.cloneNode(true);
            const newDropdown = dropdown.cloneNode(true);

            trigger.parentNode.replaceChild(newTrigger, trigger);
            dropdown.parentNode.replaceChild(newDropdown, dropdown);

            // Re-query elements from the new nodes (including valueDisplay!)
            const arrow = newTrigger.querySelector('.custom-select-arrow');
            const newSearchInput = newDropdown.querySelector('.aar-ship-search-input');
            const newOptionsContainer = newDropdown.querySelector('.custom-select-options');
            const valueDisplay = document.getElementById(selectId + '-value'); // Re-query after cloning

            newTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = !newDropdown.classList.contains('hidden');

                document.querySelectorAll('.custom-select-dropdown').forEach(dd => {
                    if (dd !== newDropdown) {
                        dd.classList.add('hidden');
                    }
                });

                newDropdown.classList.toggle('hidden');
                newTrigger.classList.toggle('ring-1');
                newTrigger.classList.toggle('ring-primary-500');
                arrow.classList.toggle('rotate-180');

                if (!isOpen) {
                    newSearchInput.value = '';
                    newOptionsContainer.querySelectorAll('.custom-select-option').forEach(opt => opt.classList.remove('hidden'));
                    newSearchInput.focus();
                }
            });

            newSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                newOptionsContainer.querySelectorAll('.custom-select-option').forEach(option => {
                    const text = option.textContent.toLowerCase();
                    option.classList.toggle('hidden', !text.includes(searchTerm));
                });
            });

            newSearchInput.addEventListener('click', (e) => e.stopPropagation());

            newOptionsContainer.addEventListener('click', (e) => {
                const option = e.target.closest('.custom-select-option');
                if (!option) return;

                const value = option.dataset.value;
                valueDisplay.textContent = value;

                newDropdown.classList.add('hidden');
                newTrigger.classList.remove('ring-1', 'ring-primary-500');
                arrow.classList.remove('rotate-180');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    newDropdown.classList.add('hidden');
                    newTrigger.classList.remove('ring-1', 'ring-primary-500');
                    arrow.classList.remove('rotate-180');
                }
            });
        }

        // Populate and initialize "Client Extracted To" dropdown
        function populateExtractedToDropdown() {
            const optionsContainer = document.getElementById('aar-extracted-options');
            if (!optionsContainer || !LOCATIONS_DATABASE) return;

            let options = '';

            // Add common options first
            options += `<div class="px-2 py-1 text-xs font-semibold text-gray-400 uppercase">Common</div>`;
            options += `<div class="custom-select-option cursor-pointer px-3 py-2 text-sm text-gray-300 hover:bg-mrs-button hover:text-white" data-value="Player Ship">Player Ship</div>`;
            options += `<div class="custom-select-option cursor-pointer px-3 py-2 text-sm text-gray-300 hover:bg-mrs-button hover:text-white" data-value="Declined">Declined</div>`;
            options += `<div class="custom-select-option cursor-pointer px-3 py-2 text-sm text-gray-300 hover:bg-mrs-button hover:text-white" data-value="N/A">N/A</div>`;

            // Collect all stations from all systems
            const allStations = [];
            for (const [systemKey, systemData] of Object.entries(LOCATIONS_DATABASE.systems)) {
                // Add jump point stations
                if (systemData.jumpPointStations) {
                    systemData.jumpPointStations.forEach(station => {
                        allStations.push(station);
                    });
                }

                for (const [planetKey, planetData] of Object.entries(systemData.planets)) {
                    // Add planet stations
                    if (planetData.stations) {
                        planetData.stations.forEach(station => {
                            allStations.push(`${station} (${planetData.name})`);
                        });
                    }
                    // Add lagrange stations
                    if (planetData.lagrangeStations) {
                        planetData.lagrangeStations.forEach(station => {
                            allStations.push(station);
                        });
                    }
                    // Add landing zones (cities)
                    if (planetData.landingZones) {
                        planetData.landingZones.forEach(city => {
                            allStations.push(`${city} (${planetData.name})`);
                        });
                    }
                }
            }

            // Sort alphabetically
            allStations.sort();

            // Add stations section
            if (allStations.length > 0) {
                options += `<div class="px-2 py-1 mt-2 text-xs font-semibold text-gray-400 uppercase border-t border-gray-600 pt-2">Stations & Landing Zones</div>`;
                allStations.forEach(station => {
                    options += `<div class="custom-select-option cursor-pointer px-3 py-2 text-sm text-gray-300 hover:bg-mrs-button hover:text-white" data-value="${station}">${station}</div>`;
                });
            }

            // Add "Other" option at the end
            options += `<div class="custom-select-option cursor-pointer px-3 py-2 text-sm text-gray-300 hover:bg-mrs-button hover:text-white border-t border-gray-600 mt-2 pt-2" data-value="Other">Other (specify below)</div>`;

            optionsContainer.innerHTML = options;

            // Initialize the custom select
            initializeExtractedToSelect();
        }

        // Initialize "Client Extracted To" select
        function initializeExtractedToSelect() {
            const wrapper = document.getElementById('aar-extracted-select');
            if (!wrapper) return;

            const trigger = wrapper.querySelector('.custom-select-trigger');
            const dropdown = wrapper.querySelector('.custom-select-dropdown');
            const searchInput = wrapper.querySelector('.extracted-search-input');
            const optionsContainer = wrapper.querySelector('.custom-select-options');

            const newTrigger = trigger.cloneNode(true);
            const newDropdown = dropdown.cloneNode(true);

            trigger.parentNode.replaceChild(newTrigger, trigger);
            dropdown.parentNode.replaceChild(newDropdown, dropdown);

            const newArrow = newTrigger.querySelector('.custom-select-arrow');
            const newSearchInput = newDropdown.querySelector('.extracted-search-input');
            const newOptionsContainer = newDropdown.querySelector('.custom-select-options');
            const valueDisplay = document.getElementById('aar-extracted-value');

            newTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = !newDropdown.classList.contains('hidden');

                document.querySelectorAll('.custom-select-dropdown').forEach(dd => {
                    if (dd !== newDropdown) dd.classList.add('hidden');
                });

                newDropdown.classList.toggle('hidden');
                newTrigger.classList.toggle('ring-1', 'ring-primary-500');
                newArrow.classList.toggle('rotate-180');

                if (!isOpen) {
                    newSearchInput.value = '';
                    newOptionsContainer.querySelectorAll('.custom-select-option').forEach(opt => opt.classList.remove('hidden'));
                    newSearchInput.focus();
                }
            });

            newSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                newOptionsContainer.querySelectorAll('.custom-select-option').forEach(option => {
                    const text = option.textContent.toLowerCase();
                    option.classList.toggle('hidden', !text.includes(searchTerm));
                });
            });

            newSearchInput.addEventListener('click', (e) => e.stopPropagation());

            newOptionsContainer.addEventListener('click', (e) => {
                const option = e.target.closest('.custom-select-option');
                if (!option) return;

                const value = option.dataset.value;
                valueDisplay.textContent = value;

                // Show/hide "Other" free-form input
                const extractedOther = document.getElementById('aar-extracted-other');
                if (extractedOther) {
                    if (value === 'Other') {
                        extractedOther.classList.remove('hidden');
                    } else {
                        extractedOther.classList.add('hidden');
                        extractedOther.value = '';
                    }
                }

                newDropdown.classList.add('hidden');
                newTrigger.classList.remove('ring-1', 'ring-primary-500');
                newArrow.classList.remove('rotate-180');
            });

            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    newDropdown.classList.add('hidden');
                    newTrigger.classList.remove('ring-1', 'ring-primary-500');
                    newArrow.classList.remove('rotate-180');
                }
            });
        }

        // Initialize AAR planet select
        function initializeAARPlanetSelect() {
            const wrapper = document.getElementById('aar-planet-select');
            if (!wrapper) return;

            const trigger = wrapper.querySelector('.custom-select-trigger');
            const dropdown = wrapper.querySelector('.custom-select-dropdown');
            const searchInput = wrapper.querySelector('.planet-search-input');
            const optionsContainer = wrapper.querySelector('.custom-select-options');

            // Remove old listeners by cloning and replacing
            const newTrigger = trigger.cloneNode(true);
            const newDropdown = dropdown.cloneNode(true);

            trigger.parentNode.replaceChild(newTrigger, trigger);
            dropdown.parentNode.replaceChild(newDropdown, dropdown);

            // Get fresh references (including valueDisplay!)
            const newArrow = newTrigger.querySelector('.custom-select-arrow');
            const newSearchInput = newDropdown.querySelector('.planet-search-input');
            const newOptionsContainer = newDropdown.querySelector('.custom-select-options');
            const valueDisplay = document.getElementById('aar-planet-value'); // Re-query after cloning

            newTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = !newDropdown.classList.contains('hidden');

                document.querySelectorAll('.custom-select-dropdown').forEach(dd => {
                    if (dd !== newDropdown) dd.classList.add('hidden');
                });

                newDropdown.classList.toggle('hidden');
                newTrigger.classList.toggle('ring-1', 'ring-primary-500');
                newArrow.classList.toggle('rotate-180');

                if (!isOpen) {
                    newSearchInput.value = '';
                    newOptionsContainer.querySelectorAll('.custom-select-option').forEach(opt => opt.classList.remove('hidden'));
                    newSearchInput.focus();
                }
            });

            newSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                newOptionsContainer.querySelectorAll('.custom-select-option').forEach(option => {
                    const text = option.textContent.toLowerCase();
                    option.classList.toggle('hidden', !text.includes(searchTerm));
                });
            });

            newSearchInput.addEventListener('click', (e) => e.stopPropagation());

            newOptionsContainer.addEventListener('click', (e) => {
                const option = e.target.closest('.custom-select-option');
                if (!option) return;

                const value = option.dataset.value;
                valueDisplay.textContent = value;

                // Populate POI dropdown for selected planet
                populateAARPOIDropdown(value);

                // Reset POI selection
                document.getElementById('aar-poi-value').textContent = 'Select POI...';

                newDropdown.classList.add('hidden');
                newTrigger.classList.remove('ring-1', 'ring-primary-500');
                newArrow.classList.remove('rotate-180');
            });

            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    newDropdown.classList.add('hidden');
                    newTrigger.classList.remove('ring-1', 'ring-primary-500');
                    newArrow.classList.remove('rotate-180');
                }
            });
        }

        // Initialize AAR POI select
        function initializeAARPOISelect() {
            const wrapper = document.getElementById('aar-poi-select');
            if (!wrapper) return;

            const trigger = wrapper.querySelector('.custom-select-trigger');
            const dropdown = wrapper.querySelector('.custom-select-dropdown');
            const searchInput = wrapper.querySelector('.poi-search-input');
            const optionsContainer = wrapper.querySelector('.custom-select-options');

            // Remove old listeners by cloning and replacing
            const newTrigger = trigger.cloneNode(true);
            const newDropdown = dropdown.cloneNode(true);

            trigger.parentNode.replaceChild(newTrigger, trigger);
            dropdown.parentNode.replaceChild(newDropdown, dropdown);

            // Get fresh references (including valueDisplay!)
            const newArrow = newTrigger.querySelector('.custom-select-arrow');
            const newSearchInput = newDropdown.querySelector('.poi-search-input');
            const newOptionsContainer = newDropdown.querySelector('.custom-select-options');
            const valueDisplay = document.getElementById('aar-poi-value'); // Re-query after cloning

            newTrigger.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpen = !newDropdown.classList.contains('hidden');

                document.querySelectorAll('.custom-select-dropdown').forEach(dd => {
                    if (dd !== newDropdown) dd.classList.add('hidden');
                });

                newDropdown.classList.toggle('hidden');
                newTrigger.classList.toggle('ring-1', 'ring-primary-500');
                newArrow.classList.toggle('rotate-180');

                if (!isOpen) {
                    newSearchInput.value = '';
                    newOptionsContainer.querySelectorAll('.custom-select-option').forEach(opt => opt.classList.remove('hidden'));
                    newSearchInput.focus();
                }
            });

            newSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                newOptionsContainer.querySelectorAll('.custom-select-option').forEach(option => {
                    const text = option.textContent.toLowerCase();
                    option.classList.toggle('hidden', !text.includes(searchTerm));
                });
            });

            newSearchInput.addEventListener('click', (e) => e.stopPropagation());

            newOptionsContainer.addEventListener('click', (e) => {
                const option = e.target.closest('.custom-select-option');
                if (!option) return;

                const value = option.dataset.value;
                valueDisplay.textContent = value;

                // Show/hide POI "Other" free-form input
                const poiOther = document.getElementById('aar-poi-other');
                if (poiOther) {
                    if (value === 'Other') {
                        poiOther.classList.remove('hidden');
                    } else {
                        poiOther.classList.add('hidden');
                        poiOther.value = '';
                    }
                }

                newDropdown.classList.add('hidden');
                newTrigger.classList.remove('ring-1', 'ring-primary-500');
                newArrow.classList.remove('rotate-180');
            });

            document.addEventListener('click', (e) => {
                if (!wrapper.contains(e.target)) {
                    newDropdown.classList.add('hidden');
                    newTrigger.classList.remove('ring-1', 'ring-primary-500');
                    newArrow.classList.remove('rotate-180');
                }
            });
        }

        // Generate AAR output
        function generateAARPreview() {
            let aar = 'SHIPS USED\n\n';

            // Ships
            const gunship = document.getElementById('aar-gunship-value').textContent;
            const medical = document.getElementById('aar-medical-value').textContent;
            const capShips = document.getElementById('aar-cap-ships').value;
            const additionalShips = document.getElementById('aar-additional-ships').value;
            const reason = document.getElementById('aar-reason').value;

            aar += `Gunship: ${gunship !== 'Select ship...' ? gunship : ''}\n`;
            aar += `Medical: ${medical !== 'Select ship...' ? medical : ''}\n`;
            aar += `CAP: ${capShips}\n`;
            aar += `Additional Ships: ${additionalShips}\n`;
            aar += `Reason: ${reason}\n\n`;

            // Intersystem Response
            const intersystem = document.getElementById('aar-intersystem-toggle').checked;
            if (intersystem) {
                aar += 'INTERSYSTEM RESPONSE\n\n';
            }

            // Location
            aar += 'LOCATION\n\n';
            const planet = document.getElementById('aar-planet-value').textContent;
            let locationType = document.getElementById('aar-location-type').value;
            const locationTypeOther = document.getElementById('aar-location-type-other').value;
            let poi = document.getElementById('aar-poi-value').textContent;
            const poiOther = document.getElementById('aar-poi-other').value;

            // Use custom input if "Other" is selected
            if (locationType === 'Other' && locationTypeOther) {
                locationType = locationTypeOther;
            }
            if (poi === 'Other' && poiOther) {
                poi = poiOther;
            }

            aar += `Planetary Body: ${planet !== 'Select planetary body...' ? planet : ''}\n`;
            aar += `Location Type: ${locationType}\n`;
            aar += `Specific POI: ${poi !== 'Select POI...' ? poi : ''}\n\n`;

            // Timestamps
            aar += 'TIMESTAMPS\n\n';
            const alert = document.getElementById('aar-alert').value;
            const depart = document.getElementById('aar-depart').value;
            const client = document.getElementById('aar-client').value;
            const rtb = document.getElementById('aar-rtb').value;

            aar += `Alert:${alert} | Depart:${depart} | Client:${client} | RTB:${rtb}\n\n`;

            // Encounters
            aar += 'ENCOUNTERS\n\n';
            const pve = document.getElementById('aar-pve').value;
            const pvp = document.getElementById('aar-pvp').value;
            const actions = document.getElementById('aar-actions').value;

            aar += `PVE: ${pve}\n`;
            aar += `PVP: ${pvp}\n`;
            aar += `Actions Taken: ${actions}\n\n`;

            // Issues
            aar += 'ISSUES\n\n';
            const issueCheckboxes = document.querySelectorAll('.aar-issue-checkbox:checked');
            const issues = Array.from(issueCheckboxes).map(cb => cb.value).join(', ');
            const otherIssues = document.getElementById('aar-other-issues').value;
            const fix = document.getElementById('aar-fix').value;

            aar += `Problems: ${issues}${otherIssues ? (issues ? ', ' : '') + otherIssues : ''}\n`;
            aar += `Brief Fix: ${fix}\n\n`;

            // Summary
            aar += 'SUMMARY\n\n';
            const summary = document.getElementById('aar-summary').value;
            aar += `${summary}\n\n`;

            // Result
            aar += 'RESULT\n\n';
            const outcome = document.getElementById('aar-outcome').value;
            let extractedTo = document.getElementById('aar-extracted-value').textContent;
            const extractedOther = document.getElementById('aar-extracted-other').value;
            let challenges = document.getElementById('aar-challenges').value;
            const challengesOther = document.getElementById('aar-challenges-other').value;
            const failure = document.getElementById('aar-failure').value;

            // Use custom input if "Other" is selected
            if (extractedTo === 'Other' && extractedOther) {
                extractedTo = extractedOther;
            }
            // Don't show placeholder text
            if (extractedTo === 'Select...') {
                extractedTo = '';
            }

            // Use custom input for challenges if "Other" is selected
            if (challenges === 'Other' && challengesOther) {
                challenges = challengesOther;
            }

            aar += `Mission Outcome: ${outcome}\n`;
            // Only show "Client Extracted To" if outcome is Success
            if (outcome === 'Success') {
                aar += `Client Extracted To: ${extractedTo}\n`;
            }
            aar += `Challenges: ${challenges}\n`;
            aar += `Failure/Abort Reason: ${failure}\n\n`;

            // Notes
            aar += 'NOTES:\n\n';
            const notes = document.getElementById('aar-notes').value;
            aar += notes;

            // Update preview
            document.getElementById('aar-preview').textContent = aar;
        }

        // Copy AAR to clipboard
        function copyAARToClipboard() {
            const output = document.getElementById('aar-preview').textContent;

            if (!navigator.clipboard) {
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = output;
                    textArea.style.position = 'fixed';
                    textArea.style.top = '0';
                    textArea.style.left = '0';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showAARSuccessMessage();
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    alert('Failed to copy to clipboard. Please try again.');
                }
                return;
            }

            navigator.clipboard.writeText(output).then(() => {
                showAARSuccessMessage();
            }).catch(err => {
                alert('Failed to copy to clipboard. Please try again.');
                console.error('Failed to copy:', err);
            });
        }

        function showAARSuccessMessage() {
            const successMessage = document.getElementById('aar-successMessage');
            successMessage.classList.remove('hidden');
            setTimeout(() => {
                successMessage.classList.add('hidden');
            }, 3000);
        }

        // Clear AAR form
        function clearAAR() {
            // Reset all select values
            document.getElementById('aar-gunship-value').textContent = 'Select ship...';
            document.getElementById('aar-medical-value').textContent = 'Select ship...';
            document.getElementById('aar-planet-value').textContent = 'Select planetary body...';
            document.getElementById('aar-poi-value').textContent = 'Select POI...';
            document.getElementById('aar-extracted-value').textContent = 'Select...';

            // Reset all inputs
            document.getElementById('aar-cap-ships').value = '';
            document.getElementById('aar-additional-ships').value = '';
            document.getElementById('aar-reason').value = '';
            document.getElementById('aar-location-type').value = '';
            document.getElementById('aar-location-type-other').value = '';
            document.getElementById('aar-poi-other').value = '';
            document.getElementById('aar-extracted-other').value = '';
            document.getElementById('aar-alert').value = '00';
            document.getElementById('aar-depart').value = '';
            document.getElementById('aar-client').value = '';
            document.getElementById('aar-rtb').value = '';
            document.getElementById('aar-pve').value = '';
            document.getElementById('aar-pvp').value = '';
            document.getElementById('aar-actions').value = '';
            document.getElementById('aar-other-issues').value = '';
            document.getElementById('aar-fix').value = '';
            document.getElementById('aar-summary').value = '';
            document.getElementById('aar-outcome').value = '';
            document.getElementById('aar-challenges').value = '';
            document.getElementById('aar-challenges-other').value = '';
            document.getElementById('aar-failure').value = '';
            document.getElementById('aar-notes').value = '';

            // Hide all "Other" free-form inputs
            document.getElementById('aar-location-type-other').classList.add('hidden');
            document.getElementById('aar-poi-other').classList.add('hidden');
            document.getElementById('aar-extracted-other').classList.add('hidden');
            document.getElementById('aar-challenges-other').classList.add('hidden');

            // Hide extracted container (only shown when outcome is Success)
            document.getElementById('aar-extracted-container').classList.add('hidden');

            // Uncheck all checkboxes
            document.getElementById('aar-intersystem-toggle').checked = false;
            document.querySelectorAll('.aar-issue-checkbox').forEach(cb => cb.checked = false);

            // Reset preview
            document.getElementById('aar-preview').textContent = 'Generate AAR to see preview...';
        }

        // Initialize planetary bodies on page load
        initializePlanetaryBodies();

        // ===== TIP SPLITTER FUNCTIONALITY =====

        let tipRecipients = [];

        // Import crew count from ship assignments
        function importCrewForTip() {
            const totalCrew = ships.reduce((sum, ship) => sum + ship.crew.length, 0);

            if (totalCrew === 0) {
                alert('No crew members found in ship assignments. Please add crew first or enter a number manually.');
                return;
            }

            document.getElementById('tip-recipients').value = totalCrew;
            generateRecipientsList(totalCrew);
        }

        // Generate recipients list
        function generateRecipientsList(count) {
            const container = document.getElementById('tip-recipients-list');

            if (!count || count < 1) {
                container.innerHTML = '<div class="px-3 py-2 text-sm text-gray-400">Add crew members by entering a number above or importing from ship assignments.</div>';
                tipRecipients = [];
                return;
            }

            tipRecipients = [];
            let html = '';

            for (let i = 1; i <= count; i++) {
                tipRecipients.push({
                    id: i,
                    name: `Recipient ${i}`,
                    choice: 'keep' // Options: 'keep', 'decline', 'logistics'
                });

                html += `
                    <div class="flex flex-col gap-2 rounded-lg border border-gray-700 bg-mrs-bg p-3 md:flex-row md:items-center md:gap-3">
                        <span class="flex-shrink-0 font-semibold text-blue-300">#${i}</span>
                        <input type="text" placeholder="Name (optional)" value="" onchange="updateRecipientName(${i}, this.value)" class="flex-1 rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                        <select onchange="updateRecipientChoice(${i}, this.value)" class="flex-shrink-0 rounded-lg border border-gray-600 bg-gray-700 px-3 py-2 text-sm text-gray-200 transition focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500">
                            <option value="keep">Keep Tip</option>
                            <option value="decline">Don't Want Tip</option>
                            <option value="logistics">Donate to Logistics</option>
                        </select>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Update recipient name
        function updateRecipientName(id, name) {
            const recipient = tipRecipients.find(r => r.id === id);
            if (recipient) {
                recipient.name = name || `Recipient ${id}`;
            }
        }

        // Update recipient choice
        function updateRecipientChoice(id, choice) {
            const recipient = tipRecipients.find(r => r.id === id);
            if (recipient) {
                recipient.choice = choice;
            }
        }

        // Watch for changes to recipient count
        document.addEventListener('DOMContentLoaded', () => {
            const recipientsInput = document.getElementById('tip-recipients');
            if (recipientsInput) {
                recipientsInput.addEventListener('input', (e) => {
                    const count = parseInt(e.target.value) || 0;
                    generateRecipientsList(count);
                });
            }

            // Show/hide Location Type "Other" free-form input
            const locationTypeSelect = document.getElementById('aar-location-type');
            const locationTypeOther = document.getElementById('aar-location-type-other');
            if (locationTypeSelect && locationTypeOther) {
                locationTypeSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'Other') {
                        locationTypeOther.classList.remove('hidden');
                    } else {
                        locationTypeOther.classList.add('hidden');
                        locationTypeOther.value = '';
                    }
                });
            }

            // Show/hide Challenges "Other" free-form input
            const challengesSelect = document.getElementById('aar-challenges');
            const challengesOther = document.getElementById('aar-challenges-other');
            if (challengesSelect && challengesOther) {
                challengesSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'Other') {
                        challengesOther.classList.remove('hidden');
                    } else {
                        challengesOther.classList.add('hidden');
                        challengesOther.value = '';
                    }
                });
            }

            // Show/hide "Client Extracted To" based on mission outcome
            const outcomeSelect = document.getElementById('aar-outcome');
            const extractedContainer = document.getElementById('aar-extracted-container');
            if (outcomeSelect && extractedContainer) {
                outcomeSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'Success') {
                        extractedContainer.classList.remove('hidden');
                    } else {
                        extractedContainer.classList.add('hidden');
                        // Reset extracted fields when hidden
                        document.getElementById('aar-extracted-value').textContent = 'Select...';
                        document.getElementById('aar-extracted-other').value = '';
                        document.getElementById('aar-extracted-other').classList.add('hidden');
                    }
                });
            }
        });

        // ===== TIP SPLITTER HELPER FUNCTIONS =====

        /**
         * Calculates the total cost (amount + fee) for a given transfer.
         * The fee is 0.5% rounded UP (matching Star Citizen's behavior).
         */
        function getTransferCost(amountSent) {
            if (amountSent <= 0) return 0;
            // Use integers to avoid floating point issues
            const amount = Math.floor(amountSent);
            const fee = Math.ceil(amount * 0.005);
            return amount + fee;
        }

        /**
         * Finds the maximum amount you can *send* (transferAmount)
         * so that the *total cost* (including the rounded-up fee)
         * does not exceed the allottedShare (our "budget").
         */
        function findMaxTransferAmount(allottedShare) {
            if (allottedShare <= 0) return 0;

            let guessAmount = Math.floor(allottedShare / 1.005);
            let costOfGuess = getTransferCost(guessAmount);

            if (costOfGuess > allottedShare) {
                while (costOfGuess > allottedShare) {
                    guessAmount--;
                    costOfGuess = getTransferCost(guessAmount);
                }
            } else {
                while (getTransferCost(guessAmount + 1) <= allottedShare) {
                    guessAmount++;
                }
            }
            return guessAmount;
        }

        /**
         * Finds the maximum "Equal Take-Home Amount" (X) where everyone receives
         * the same amount, accounting for all transfer fees.
         * This is the core fair distribution algorithm.
         */
        function findEqualTakeHomeAmount(totalActivePool, totalActiveShares, numKeeperTransfers, activeDonatorsCount, leadIsKeeping) {
            if (totalActiveShares === 0) return 0;

            // Start with a guess that ignores fees.
            let guessAmount = Math.floor(totalActivePool / totalActiveShares);

            while (guessAmount > 0) {
                // --- Calculate the total cost for this "guessAmount" (X) ---
                let totalCostForThisGuess = 0;

                // 1. Cost for all keeper transfers
                totalCostForThisGuess += getTransferCost(guessAmount) * numKeeperTransfers;

                // 2. Cost for logistics transfer
                if (activeDonatorsCount > 0) {
                    // The logistics pool is entitled to X * (number of donators)
                    const logisticsPoolEntitlement = guessAmount * activeDonatorsCount;
                    // Find the max we can send that is <= this entitlement
                    const logisticsTransferAmount = findMaxTransferAmount(logisticsPoolEntitlement);
                    // Add the *cost* of sending that amount
                    totalCostForThisGuess += getTransferCost(logisticsTransferAmount);
                }

                // 3. Cost for lead (if keeping)
                if (leadIsKeeping) {
                    totalCostForThisGuess += guessAmount; // Fee is 0
                }

                // --- Check if this guess is valid ---
                if (totalCostForThisGuess <= totalActivePool) {
                    // This guess is valid. Since we're counting down, this is
                    // the highest possible "equal" amount.
                    return guessAmount;
                }

                // This guess was too high. Try a smaller amount.
                guessAmount--;
            }

            return 0; // No solution found (e.g., fees > pool)
        }

        // Calculate tip split with fair distribution algorithm
        function calculateTipSplit() {
            const totalTip = Math.floor(parseFloat(document.getElementById('tip-total').value)) || 0;

            // --- 0. VALIDATION ---
            if (totalTip <= 0) {
                alert('Please enter a valid tip amount.');
                return;
            }

            if (tipRecipients.length === 0) {
                alert('Please add recipients first.');
                return;
            }

            const leadChoice = document.getElementById('tip-lead-choice').value;
            const totalPartySize = tipRecipients.length + 1; // Always include lead in party size

            // --- 1. CATEGORIZE ALL PARTICIPANTS ---
            const keepingRecipients = tipRecipients.filter(r => r.choice === 'keep');
            const donatingRecipients = tipRecipients.filter(r => r.choice === 'logistics');
            const decliningRecipients = tipRecipients.filter(r => r.choice === 'decline');

            const leadIsKeeping = (leadChoice === 'lead-keep');
            const leadIsDonating = (leadChoice === 'lead-logistics');
            const leadIsDeclining = (leadChoice === 'lead-decline');

            // --- 2. CALCULATE "ACTIVE" POOL AND SHARES ---
            // "Active" means anyone NOT declining.

            // 2a. Find total shares to split the tip by.
            const numDecliners = decliningRecipients.length + (leadIsDeclining ? 1 : 0);
            const totalActiveShares = totalPartySize - numDecliners;

            // 2b. The "Active Pool" is the entire tip, to be split by the active shares.
            const totalActivePool = totalTip;

            // 2c. Handle "everyone declined" edge case
            if (totalActiveShares === 0) {
                // Everyone declined. Lead keeps everything.
                displayTipResults([], null, totalTip, totalPartySize, 0, 0, 0, totalTip, [], decliningRecipients, leadChoice);
                return;
            }

            // 2d. Calculate the *old* base share just for display
            const oldBaseShare = Math.floor(totalTip / totalPartySize);

            // 2e. Find how many "active" participants are in each category
            const numActiveKeepers = keepingRecipients.length + (leadIsKeeping ? 1 : 0);
            const numActiveDonators = donatingRecipients.length + (leadIsDonating ? 1 : 0);

            // 2f. Find how many *transfers* are needed
            const numKeeperTransfers = keepingRecipients.length; // Only recipients (not lead)
            const numLogisticsTransfers = (numActiveDonators > 0) ? 1 : 0; // Only one transfer

            // --- 3. Find the "Equal Take-Home Amount" (X) ---
            // This is the core logic. Find the highest amount X that can be
            // given to all active participants.
            const equalTakeHomeAmount = findEqualTakeHomeAmount(
                totalActivePool,
                totalActiveShares,
                numKeeperTransfers,
                numActiveDonators, // How many shares go to logistics
                leadIsKeeping
            );

            // --- 4. Calculate Final Transfers based on this Equal Amount ---
            const transfers = [];
            let totalCostOfTransfers = 0;
            let totalFeesAmount = 0;

            // 4a. Transfers to crew keeping tips
            keepingRecipients.forEach(recipient => {
                const transferAmount = equalTakeHomeAmount; // This is their take-home
                const youPay = getTransferCost(transferAmount);
                const fee = youPay - transferAmount;

                transfers.push({
                    recipient: recipient,
                    transferAmount: transferAmount,
                    fee: fee,
                    receivedAmount: transferAmount,
                    youPay: youPay,
                    type: 'crew'
                });
                totalCostOfTransfers += youPay;
                totalFeesAmount += fee;
            });

            // 4b. Transfer to Logistics
            let logisticsTransfer = null;
            let logisticsCost = 0;
            if (numLogisticsTransfers > 0) {
                // The logistics pool is entitled to X * (number of donators)
                const logisticsPoolEntitlement = equalTakeHomeAmount * numActiveDonators;
                // Find the max we can send that is <= this entitlement
                const logisticsTransferAmount = findMaxTransferAmount(logisticsPoolEntitlement);

                if (logisticsTransferAmount > 0) {
                    logisticsCost = getTransferCost(logisticsTransferAmount);
                    const logisticsFee = logisticsCost - logisticsTransferAmount;

                    logisticsTransfer = {
                        transferAmount: logisticsTransferAmount,
                        fee: logisticsFee,
                        receivedAmount: logisticsTransferAmount,
                        youPay: logisticsCost
                    };
                    totalCostOfTransfers += logisticsCost;
                    totalFeesAmount += logisticsFee;
                }
            }

            // --- 4c. Calculate Final Lead Keep Amount ---

            // The lead's share is their equal take-home (if they're keeping)
            const leadShare = leadIsKeeping ? equalTakeHomeAmount : 0;

            // The total *spent* is all transfers + the lead's own share
            const totalSpent = totalCostOfTransfers + leadShare;

            // The "dust" is the leftover from the *active pool*
            // This is the only money the lead keeps IF THEY DECLINE.
            const totalDust = totalActivePool - totalSpent;

            // The lead's final keep is their share (0 if declining/donating) + the dust.
            const leadFinalKept = (leadIsKeeping ? equalTakeHomeAmount : 0) + totalDust;

            // --- 5. Display Results ---
            displayTipResults(
                transfers,
                logisticsTransfer,
                totalTip,
                totalPartySize, // Pass original party size
                oldBaseShare,   // Pass original base share
                totalFeesAmount,
                totalCostOfTransfers, // This is just the *transfers*, not lead keep
                leadFinalKept, // This is what's left
                donatingRecipients, // Pass the recipient list
                decliningRecipients, // Pass the recipient list
                leadChoice // Pass the lead choice
            );
        }

        function displayTipResults(transfers, logisticsTransfer, totalTip, totalCrewCount, baseShare, totalFees, totalTransferred, leadKeeps, donatingToLogistics, declining, leadChoice) {
            const resultsContainer = document.getElementById('tip-results-list');
            const logisticsContainer = document.getElementById('tip-logistics-transfer');
            const resultsSection = document.getElementById('tip-results');

            let html = '';

            // Display crew transfers
            transfers.forEach((transfer, index) => {
                const name = transfer.recipient.name || `Recipient ${transfer.recipient.id}`;
                html += `
                    <div class="grid grid-cols-3 gap-4 border-b border-gray-800 py-2 text-sm">
                        <div class="text-gray-300">${name}</div>
                        <div class="text-right font-mono text-white">${Math.round(transfer.transferAmount).toLocaleString()} aUEC</div>
                        <div class="text-right font-mono text-green-300">${Math.round(transfer.receivedAmount).toLocaleString()} aUEC</div>
                    </div>
                `;
            });

            // Handle case where no one is keeping
            if (transfers.length === 0) {
                html = '<div class="mt-3 rounded-lg border border-gray-600 bg-gray-800/50 p-3 text-sm text-gray-400 text-center">No crew members are keeping their share.</div>';
            }

            resultsContainer.innerHTML = html;

            // Display logistics transfer if any
            if (logisticsTransfer) {
                const donorNames = donatingToLogistics.map(r => r.name || `Recipient ${r.id}`);
                // Add lead to donor names if they donated
                if (leadChoice === 'lead-logistics') {
                    donorNames.unshift("You (Lead)");
                }

                const donorCount = donorNames.length;
                const shareText = donorCount === 1 ? '1 share' : `${donorCount} shares`;

                logisticsContainer.innerHTML = `
                    <div class="grid grid-cols-3 gap-4 py-2 text-sm">
                        <div class="text-yellow-300 font-semibold">
                            Logistics Pool (${shareText})
                            <div class="text-xs text-yellow-400 font-normal mt-1">From: ${donorNames.join(', ')}</div>
                        </div>
                        <div class="text-right font-mono text-white">${Math.round(logisticsTransfer.transferAmount).toLocaleString()} aUEC</div>
                        <div class="text-right font-mono text-yellow-300">${Math.round(logisticsTransfer.receivedAmount).toLocaleString()} aUEC</div>
                    </div>
                `;
                logisticsContainer.classList.remove('hidden');
                document.getElementById('tip-summary-logistics-section').classList.remove('hidden');
                document.getElementById('tip-summary-logistics').textContent = Math.round(logisticsTransfer.receivedAmount).toLocaleString() + ' aUEC';
            } else {
                logisticsContainer.classList.add('hidden');
                document.getElementById('tip-summary-logistics-section').classList.add('hidden');
            }

            // Display note about declined tips if any
            // Find any existing "note" and remove it before adding a new one
            const existingNote = resultsContainer.querySelector('.note');
            if (existingNote) {
                existingNote.remove();
            }

            if (declining.length > 0 || leadChoice === 'lead-decline') {
                const declinedNames = declining.map(r => r.name || `Recipient ${r.id}`);
                if (leadChoice === 'lead-decline') {
                    declinedNames.unshift("You (Lead)");
                }
                const note = document.createElement('div');
                note.className = 'mt-3 rounded-lg border border-gray-600 bg-gray-800/50 p-3 text-sm text-gray-400';
                note.innerHTML = `<strong>Declined Tips (redistributed):</strong> ${declinedNames.join(', ')}`;
                resultsContainer.appendChild(note);
            }

            // Update summary
            document.getElementById('tip-summary-total').textContent = totalTip.toLocaleString() + ' aUEC';
            document.getElementById('tip-summary-crew-count').textContent = totalCrewCount;
            document.getElementById('tip-summary-share').textContent = Math.round(baseShare).toLocaleString() + ' aUEC';
            document.getElementById('tip-summary-fees').textContent = Math.round(totalFees).toLocaleString() + ' aUEC';
            document.getElementById('tip-summary-transfer').textContent = Math.round(totalTransferred).toLocaleString() + ' aUEC';
            document.getElementById('tip-summary-keep').textContent = Math.round(leadKeeps).toLocaleString() + ' aUEC';

            // Show results section
            resultsSection.classList.remove('hidden');
        }
    </script>
</body>
</html>